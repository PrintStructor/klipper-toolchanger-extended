# ==============================================================================
# VORON TOOLCHANGER — BEACON PROBE CONFIGURATION
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Description:
#   Configuration for Beacon RevH eddy current probe used for:
#   - Z-axis homing (proximity and contact modes)
#   - Bed mesh generation with high precision
#   - Sensorless X/Y homing with current adjustment
#   - Toolchanger initialization integration
#
# Features:
#   - Dual homing modes (proximity for speed, contact for accuracy)
#   - Automatic toolchanger initialization on Z-home
#   - Sensorless homing with TMC current management
#   - Optimized bed mesh parameters for low deviation
#   - LED status integration during homing
#
# Structure:
#   1. Beacon Hardware Configuration
#   2. Bed Mesh Settings
#   3. Homing Helper Macros
#   4. Manual Homing Shortcuts
#
# Important Notes:
#   - x_offset/y_offset must match your physical nozzle-to-probe distance
#   - Sensorless homing requires properly tuned TMC stallguard settings
#   - Contact mode limited to 185°C max hotend temperature
#
# ==============================================================================

# ==============================================================================
# SECTION 1: BEACON HARDWARE CONFIGURATION
# ==============================================================================

[beacon]
# ------------------------------------------------------------------------------
# Hardware Connection
# ------------------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_0ECBA98F5154364134202020FF141F31-if00

# ------------------------------------------------------------------------------
# Probe Calibration
# ------------------------------------------------------------------------------
backlash_comp: 0.00531              # Mechanical backlash compensation
x_offset: 0                         # Nozzle to probe offset in X (update for your machine)
y_offset: 34                        # Nozzle to probe offset in Y (update for your machine)

# ------------------------------------------------------------------------------
# Mesh Optimization
# ------------------------------------------------------------------------------
mesh_main_direction: x              # Primary scanning direction for bed mesh
mesh_runs: 2                        # Number of mesh passes for averaging
#accel_axes_map: x, y, z            # Accelerometer axis mapping (optional)

# ------------------------------------------------------------------------------
# Probing Modes
# ------------------------------------------------------------------------------
#default_probe_method: proximity    # Default: proximity for speed, contact for accuracy
contact_max_hotend_temperature: 185 # Safety limit for contact mode (prevents nozzle damage)

# ------------------------------------------------------------------------------
# Homing Sequence Integration
# ------------------------------------------------------------------------------
# These gcode blocks are executed automatically during G28 commands

home_gcode_pre_x:
    # Executed before X-axis homing
    SET_LED_EFFECT EFFECT=homing       # Visual feedback
    _HOME_PRE_AXIS AXIS=X              # Reduce stepper current for sensorless homing

home_gcode_post_x:
    # Executed after X-axis homing
    _HOME_POST_AXIS AXIS=X             # Restore stepper current

home_gcode_pre_y:
    # Executed before Y-axis homing
    SET_LED_EFFECT EFFECT=homing       # Visual feedback
    G90                                # Absolute positioning
    G1 X177.5 F12000                   # Move to bed center X
    _HOME_PRE_AXIS AXIS=Y              # Reduce stepper current

home_gcode_post_y:
    # Executed after Y-axis homing
    _HOME_POST_AXIS AXIS=Y             # Restore stepper current

home_gcode_pre_z:
    # Executed before Z-axis homing
    SET_LED_EFFECT EFFECT=homing       # Visual feedback
    _INITIALIZE_TOOLCHANGER            # Ensure toolchanger is ready

# ------------------------------------------------------------------------------
# Homing Parameters
# ------------------------------------------------------------------------------
home_xy_position: 177.5, 177.5      # Center of bed for Z-homing (update for your bed size)
home_z_hop: 6                        # Z-lift after homing (mm)
#home_z_hop: 10                      # Alternative higher lift for safety
home_z_hop_speed: 30                 # Speed for Z-hop moves (mm/s)
home_xy_move_speed: 300              # Speed for XY positioning before Z-home (mm/s)

home_method: proximity               # Initial homing method (proximity=fast, contact=accurate)
home_method_when_homed: proximity    # Method for subsequent homes (proximity for speed)
home_autocalibrate: unhomed          # Auto-calibrate contact mode on first home after power-on

# ------------------------------------------------------------------------------
# Resonance Testing (Optional)
# ------------------------------------------------------------------------------
# Uncomment to use Beacon as accelerometer for input shaper tuning
#[resonance_tester]
#accel_chip: beacon
#probe_points: 177.5, 177.5, 20      # Center of bed at 20mm height
#max_freq: 130                       # Maximum frequency to test

# ==============================================================================
# SECTION 2: BED MESH CONFIGURATION
# ==============================================================================

[bed_mesh]
# ------------------------------------------------------------------------------
# Mesh Reference
# ------------------------------------------------------------------------------
zero_reference_position: 177.5, 177.5   # Bed center as reference point (update for your bed)

# ------------------------------------------------------------------------------
# Probing Speed & Clearance
# ------------------------------------------------------------------------------
speed: 400                              # Travel speed between probe points (mm/s)
horizontal_move_z: 2                    # Z height for travel moves (mm)

# ------------------------------------------------------------------------------
# Mesh Area
# ------------------------------------------------------------------------------
mesh_min: 25, 35                        # Minimum XY coordinates for mesh
mesh_max: 330, 335                      # Maximum XY coordinates for mesh

# ------------------------------------------------------------------------------
# Mesh Resolution
# ------------------------------------------------------------------------------
probe_count: 21, 21                     # Number of probe points (X, Y)
# Historical values for reference:
#probe_count: 9, 9                      # Low resolution (fast)
#probe_count: 51, 51                    # High resolution (slow, old setting)

# ------------------------------------------------------------------------------
# Interpolation & Fade
# ------------------------------------------------------------------------------
algorithm: bicubic                      # Interpolation algorithm for smooth surface
mesh_pps: 0                             # Points per segment (0 = disable interpolation)
fade_start: 0.6                         # Z height to start fading mesh correction (mm)
fade_end: 5.0                           # Z height to complete fade (mm)
fade_target: 0                          # Target value at fade_end (0 = no correction)

# ------------------------------------------------------------------------------
# Mesh Optimization
# ------------------------------------------------------------------------------
move_check_distance: 3                  # Distance to check for mesh updates (mm)
split_delta_z: 0.0125                   # Z threshold for subdividing moves (mm)

# ==============================================================================
# SECTION 3: HOMING HELPER MACROS
# ==============================================================================

# ------------------------------------------------------------------------------
# Sensorless Homing: Current Reduction
# ------------------------------------------------------------------------------
# Reduces stepper current before sensorless homing to improve stallguard sensitivity

[gcode_macro _HOME_PRE_AXIS]
description: Reduce stepper current for sensorless homing
# Called automatically before X/Y homing via home_gcode_pre_x/y
gcode:
    # Reduced current for reliable stallguard detection
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

# ------------------------------------------------------------------------------
# Sensorless Homing: Current Restoration
# ------------------------------------------------------------------------------
# Restores normal stepper current after homing and performs safe retreat

[gcode_macro _HOME_POST_AXIS]
description: Restore stepper current and perform safe retreat after homing
# Called automatically after X/Y homing via home_gcode_post_x/y
# Parameters:
#   AXIS=<X|Y> : Which axis was just homed
gcode:
    {% set axis = params.AXIS %}
    # Read configured run currents from TMC driver config
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    
    # Perform safe retreat from endstop
    SAVE_GCODE_STATE NAME=home_post_axis
    {% if axis == "X" %}
        # X-axis: back off 10mm from endstop and pause
        G91                     # Relative positioning
        G1 X-10 F1200           # Move away from endstop
        G4 P1000                # Wait 1 second for stability
    {% elif axis == "Y" %}
        # Y-axis: return to absolute mode (retreat handled by beacon)
        G90
    {% endif %}
    RESTORE_GCODE_STATE NAME=home_post_axis
    
    # Restore normal running currents
    M400  # Wait for all moves to complete
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

# ------------------------------------------------------------------------------
# Toolchanger Initialization Helper
# ------------------------------------------------------------------------------

[gcode_macro _INITIALIZE_TOOLCHANGER]
description: Ensure toolchanger is initialized before Z-homing
# Called automatically before Z-homing via home_gcode_pre_z
# Prevents homing failures if no tool is selected
gcode:
    {% if not printer.toolchanger.status == "ready" %}
        INITIALIZE_TOOLCHANGER
    {% endif %}

# ==============================================================================
# SECTION 4: MANUAL HOMING SHORTCUTS
# ==============================================================================
# Convenience macros for manual homing with LED feedback

[gcode_macro HOME_X]
description: Home X-axis only with LED feedback
gcode:
    SET_LED_EFFECT EFFECT=homing
    G28 X

[gcode_macro HOME_Y]
description: Home Y-axis only with LED feedback
gcode:
    SET_LED_EFFECT EFFECT=homing
    G28 Y

[gcode_macro HOME_Z]
description: Home Z-axis only with LED feedback
gcode:
    SET_LED_EFFECT EFFECT=homing
    G28 Z
