# ==============================================================================
# VORON TOOLCHANGER ‚Äî CORE OPERATION & UTILITY MACROS
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
#
# Description:
#   This file contains essential macros for toolchanger operation, including:
#   - Core: Global variables and initial tool setup
#   - Utilities: Filament sensor control, demo functions, tool monitoring
#
# Usage:
#   1. Set your initial tool before printing: SET_INITIAL_TOOL TOOL=0
#   2. Use T0-T5 commands to switch tools during printing
#   3. For calibration workflows, see calibrate_offsets.cfg
#
# ==============================================================================

# ==============================================================================
# SECTION 1: CORE OPERATIONS
# ==============================================================================

# ------------------------------------------------------------------------------
# Internal Helper: Set Active Tool Flags
# ------------------------------------------------------------------------------
# NOTE: This may be deprecated if the toolchanger module handles this internally
# Status: LEGACY - Keep for backward compatibility, may be removed in future

[gcode_macro _SET_ACTIVE_TOOL_FLAGS]
description: Helper macro ‚Äì sets the variable_active flags for T0..T5
# Usage: _SET_ACTIVE_TOOL_FLAGS T=<0..5>
gcode:
  {% set t = params.T|int %}
  SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE={1 if t==0 else 0}
  SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE={1 if t==1 else 0}
  SET_GCODE_VARIABLE MACRO=T2 VARIABLE=active VALUE={1 if t==2 else 0}
  SET_GCODE_VARIABLE MACRO=T3 VARIABLE=active VALUE={1 if t==3 else 0}
  SET_GCODE_VARIABLE MACRO=T4 VARIABLE=active VALUE={1 if t==4 else 0}
  SET_GCODE_VARIABLE MACRO=T5 VARIABLE=active VALUE={1 if t==5 else 0}

# ------------------------------------------------------------------------------
# Global Variables Storage
# ------------------------------------------------------------------------------
# ESSENTIAL: Central storage for toolchanger state and offsets
# These variables persist across tool changes and are used by multiple macros

[gcode_macro globals]
description: Central storage for toolchanger state and offset values
# Tool tracking
variable_current_initial_tool: -1           # Initially selected tool (-1 = none set)
variable_current_tool: -1                   # Currently active tool number

# Z-offset configuration
variable_global_z_offset: 0.06              # Base Z-offset applied to initial tool
# Note: Adjust global_z_offset based on your Beacon calibration results
# Typical values: 0.06-0.12mm depending on nozzle characteristics

# Calibration mode control
variable_toolchanger_calibration_mode: 0    # 0 = normal operation (offsets active)
                                            # 1 = calibration mode (offsets disabled)

# NOTE: Individual tool Z-offsets are managed by the toolchanger module itself
# and stored directly in printer.cfg under [tool T0] through [tool T5] sections.
# No manual variables needed here.

gcode:
    RESPOND TYPE=echo MSG="Global toolchanger variables initialized"

# ------------------------------------------------------------------------------
# Initial Tool Setup
# ------------------------------------------------------------------------------
# ESSENTIAL: Must be called before printing to establish the reference tool

[gcode_macro SET_INITIAL_TOOL]
description: Define the initial tool as the Z-offset reference point
# Usage: SET_INITIAL_TOOL TOOL=<0-5> [FORCE_SWITCH=1]
# 
# Parameters:
#   TOOL=<0-5>      : Tool number to set as initial reference
#   FORCE_SWITCH=1  : Optional - Force switch if another tool is active
#
# Purpose:
#   - Establishes the reference tool for all Z-offset measurements
#   - Sets XY offsets to 0,0 for the initial tool
#   - Applies global_z_offset to compensate for nozzle height
#   - Must be called before starting a print
#
# Safety:
#   - Prevents accidental switches when a tool is already active
#   - Use FORCE_SWITCH=1 only if you're certain it's safe to switch
gcode:
    {% set TOOL = params.TOOL|default(-1)|int %}
    {% set FORCE_SWITCH = params.FORCE_SWITCH|default(0)|int %}
    
    {% if TOOL < 0 %}
        RESPOND TYPE=error MSG="Error: Please specify a valid tool number using TOOL=X"
    {% elif printer.toolchanger.tool_number >= 0 and printer.toolchanger.tool_number != TOOL %}
        # Another tool is already active
        {% if FORCE_SWITCH == 1 %}
            # Force switch to the new initial tool
            RESPOND MSG="‚ö†Ô∏è Switching from T{printer.toolchanger.tool_number} to T{TOOL} as new initial tool"
            SET_GCODE_VARIABLE MACRO=globals VARIABLE=current_tool VALUE={TOOL}
            RESET_INITIAL_TOOL
            SELECT_TOOL T={TOOL}
            RELOAD_TOOL_OFFSETS TOOL={TOOL}
            RESPOND MSG="‚úÖ Set T{TOOL} as new initial tool and reloaded offsets"
        {% else %}
            # Issue warning and do NOT switch (safe!)
            RESPOND TYPE=error MSG="‚ö†Ô∏è WARNING: T{printer.toolchanger.tool_number} is already active!"
            RESPOND TYPE=error MSG="To set T{TOOL} as the new initial tool, you have two options:"
            RESPOND TYPE=error MSG="1. First perform a tool change: SELECT_TOOL T={TOOL}"
            RESPOND TYPE=error MSG="2. Use FORCE_SWITCH=1 to switch automatically"
            RESPOND TYPE=error MSG="Example: SET_INITIAL_TOOL TOOL={TOOL} FORCE_SWITCH=1"
        {% endif %}
    {% else %}
        # No tool active or same tool ‚Üí safe
        SET_GCODE_VARIABLE MACRO=globals VARIABLE=current_tool VALUE={TOOL}
        {% if printer.toolchanger.tool_number < 0 %}
            # Toolchanger not yet initialized
            INITIALIZE_TOOLCHANGER TOOL="tool T{TOOL}"
        {% endif %}
        RELOAD_TOOL_OFFSETS TOOL={TOOL}
        # Direkt alle Offsets f√ºr Initial-Tool setzen (XY=0, Z=global)
        {% set global_offset = printer["gcode_macro globals"].global_z_offset|float %}
        SET_GCODE_OFFSET X=0 Y=0 Z={global_offset} ABSOLUTE=1
        RESPOND MSG="‚úÖ Set T{TOOL} as initial tool with offsets X=0 Y=0 Z={global_offset}"
    {% endif %}

# ==============================================================================
# SECTION 2: UTILITY FUNCTIONS
# ==============================================================================

# ------------------------------------------------------------------------------
# Filament Sensor Control
# ------------------------------------------------------------------------------
# ESSENTIAL: Enable/disable filament sensors during tool changes

[gcode_macro _ENABLE_FILAMENT_SENSORS]
description: Enable all filament sensors for T0-T5
# Internal helper called during tool changes
gcode:
        SET_FILAMENT_SENSOR SENSOR=T0_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T1_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T2_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T3_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T4_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T5_filament_sensor ENABLE=1

[gcode_macro _DISABLE_FILAMENT_SENSORS]
description: Disable all filament sensors for T0-T5
# Internal helper called during tool changes to prevent false triggers
gcode:
        # Disable all tool filament sensors
        SET_FILAMENT_SENSOR SENSOR=T0_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T1_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T2_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T3_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T4_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T5_filament_sensor ENABLE=0

[gcode_macro TOGGLE_FILAMENT_SENSORS]
description: Toggle filament sensor state on or off
# Usage: TOGGLE_FILAMENT_SENSORS ENABLE=1 (enable) or ENABLE=0 (disable)
#
# Purpose:
#   Manual control of all filament sensors at once
#   Useful for testing or maintenance procedures
gcode:
    {% if params.ENABLE is defined %}
        {% if params.ENABLE|int == 1 %}
            _ENABLE_FILAMENT_SENSORS
            RESPOND MSG="All filament sensors enabled"
        {% else %}
            _DISABLE_FILAMENT_SENSORS
            RESPOND MSG="All filament sensors disabled"
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="Please specify ENABLE=1 or ENABLE=0"
    {% endif %}

# ------------------------------------------------------------------------------
# Demo and Testing Functions
# ------------------------------------------------------------------------------

[gcode_macro TOOLCHANGE_DEMO]
description: Demo macro ‚Äì randomly switches tools 20 times for testing
# WARNING: Only use when printer is in a safe state!
# Purpose: Test toolchanger reliability and timing
gcode:
    RESPOND MSG="Starting toolchange demo - 20 random tool switches"
    {% for n in range(20) %}
      T{ printer.toolchanger.tool_numbers | random }
      G4 P500  # Brief pause between changes
    {% endfor %}
    RESPOND MSG="Toolchange demo complete"

# ------------------------------------------------------------------------------
# Tool Presence Monitoring
# ------------------------------------------------------------------------------
# REMOVED: Old polling-based TOOL_PRESENCE_MONITOR (replaced by event-driven system)
#
# The new system uses hardware interrupts in tool.py for instant detection (< 100ms)
# See _TOOLCHANGER_TOOL_LOSS_HANDLER macro below for the event-driven handler


# ==============================================================================
# Event-Driven Tool Loss Handler (called by tool.py)
# ==============================================================================
# This handler is called automatically by tool.py when the active tool's
# detection sensor changes from PRESENT to ABSENT during operation.
# Response time: < 100ms (hardware interrupt-driven, not polling)

[gcode_macro _TOOLCHANGER_TOOL_LOSS_HANDLER]
description: Safety handler for real-time tool loss detection (event-driven)
variable_handler_active: 0  # Recursion guard: 0=idle, 1=handling tool loss
gcode:
    # ===========================================================================
    # RECURSION GUARD: Prevent multiple simultaneous handler executions
    # ===========================================================================
    # If user toggles detection switch rapidly, or if pin bounces, tool.py will
    # call this handler multiple times. We MUST ignore subsequent calls until
    # the first one completes and user runs RESUME.

    {% if printer["gcode_macro _TOOLCHANGER_TOOL_LOSS_HANDLER"].handler_active == 1 %}
        RESPOND MSG="‚ö†Ô∏è Tool loss handler already active - ignoring duplicate trigger"
        # Exit immediately - do NOT process this call
    {% elif not printer.virtual_sdcard.is_active and not printer.pause_resume.is_paused %}
        # No print running and not paused - ignore tool loss (probably manual tool change)
        RESPOND MSG="‚ÑπÔ∏è Tool loss detected but no print active - ignoring (manual tool change OK)"
        # Exit immediately - user is probably changing tools manually
    {% else %}
        # Set flag FIRST to block any subsequent calls during this execution
        SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_TOOL_LOSS_HANDLER VARIABLE=handler_active VALUE=1

        {% set tool_num = params.T|int %}
        {% set tool_name = "tool T" ~ tool_num %}
        {% set tool_obj = printer[tool_name] %}
        {% set extruder_name = tool_obj.extruder %}
        {% set current_target = printer[extruder_name].target|float %}

        # NOTE: PAUSE is called in Python (tool.py) BEFORE this macro runs!
        # This ensures immediate print stop with minimal latency.
        # Position is automatically saved by pause_resume module.

        # =======================================================================
        # SAFETY ACTIONS
        # =======================================================================

        # 1. Report critical error
        RESPOND TYPE=error MSG="üö® CRITICAL: Tool T{tool_num} dropped during operation!"
        RESPOND TYPE=error MSG="Detection state: {tool_obj.detect_state} (1=PRESENT, 0=ABSENT)"
        M117 Tool T{tool_num} lost!

        # 2. Save temperature for RESUME macro to restore
        SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_RESUME_HANDLER VARIABLE=saved_target VALUE={current_target}

        # 3. IMMEDIATELY shut off lost tool's heater (fire safety!)
        M104 S0 T{tool_num}
        RESPOND MSG="Heater T{tool_num} emergency shutoff (was {current_target}¬∞C)"

        # 4. Lift Z to safe height (ONLY if NOT during toolchange!)
        # CRITICAL: Check toolchanger status before lifting Z!
        # During toolchange (status="changing"), toolhead is at/near dock
        # Z-lift would cause collision with dock structure!
        {% set current_z = printer.toolhead.position.z %}
        {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
        {% set safe_z_lift = 20.0 %}  # mm to lift
        {% set tc = printer.toolchanger %}
        {% set tc_status = tc.status|default("ready") %}
        {% set during_toolchange = (tc_status == "changing") %}

        {% if during_toolchange %}
            # Tool loss happened DURING TOOLCHANGE (likely at/near dock)
            RESPOND TYPE=error MSG="‚ö†Ô∏è Tool loss during toolchange detected - skipping Z-lift to prevent collision"
            RESPOND MSG="Toolchanger status: {tc_status} (toolhead at/near dock)"
            RESPOND MSG="Safe to manually reattach tool without Z movement"
        {% else %}
            # Tool loss during NORMAL PRINTING - safe to lift Z
            {% if current_z + safe_z_lift <= max_z %}
                # CRITICAL: Use absolute positioning with calculated target Z
                # Relative moves (G91) can fail if gcode state is corrupted after toolchange errors
                {% set target_z = current_z + safe_z_lift %}
                {% set current_x = printer.toolhead.position.x %}
                {% set current_y = printer.toolhead.position.y %}

                # Clear any active gcode offsets before moving
                SET_GCODE_OFFSET X=0 Y=0 Z=0

                # Move ONLY Z, keep X and Y at current position
                G90   # Absolute positioning
                G0 X{current_x} Y{current_y} Z{target_z} F600

                RESPOND MSG="‚úÖ Z lifted by {safe_z_lift}mm for safety (was at {current_z|round(1)}mm, now at {target_z|round(1)}mm)"
                RESPOND MSG="Tool loss during print (status: {tc_status}) - safe height for reattachment"
            {% else %}
                RESPOND MSG="Cannot lift Z - already near max height ({current_z|round(1)}/{max_z|round(1)}mm)"
            {% endif %}
        {% endif %}

        # 5. Set error LED status
        STATUS_ERROR

        # NOTE: Print is already paused via PAUSE (called in tool.py before this macro)
        # Position is saved automatically by pause_resume module
        # handler_active flag is cleared by RESUME macro after recovery

        # =======================================================================
        # OPTIONAL ACTIONS (uncomment to enable)
        # =======================================================================

        # Option: Park at specific safe location
        # G0 X175 Y350 F6000

        # Option: Disable ALL heaters (more aggressive than single tool)
        # TURN_OFF_HEATERS

        # Option: Send external notification (requires notification service)
        # NOTIFY_ERROR MSG="Printer paused - Tool T{tool_num} dropped!"
    {% endif %}

# ==============================================================================
# IMPLEMENTATION NOTES
# ==============================================================================
#
# How event-driven detection works:
# ----------------------------------
# - Tool detection pins are monitored by Klipper hardware interrupts
# - tool.py._handle_detect() is called on EVERY pin state change (< 1ms)
# - When active tool changes from PRESENT ‚Üí ABSENT:
#   * tool.py._handle_tool_loss() is called immediately
#   * This macro (_TOOLCHANGER_TOOL_LOSS_HANDLER) executes
#
# Advantages over polling (TOOL_PRESENCE_MONITOR delayed_gcode):
# ---------------------------------------------------------------
# ‚úÖ Instant response (< 100ms vs up to 2 seconds delay)
# ‚úÖ Zero CPU overhead (hardware interrupts vs continuous polling)
# ‚úÖ 100% reliable (can't miss tool loss between polling intervals)
# ‚úÖ Works during any operation (moves, homing, probing, etc.)
