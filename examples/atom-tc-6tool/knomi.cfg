# ==============================================================================
# VORON TOOLCHANGER â€” KNOMI DISPLAY CONFIGURATION
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Description:
#   Hardware sleep/wake control for 6x BTT KNOMI round displays (one per tool).
#   Implements power-saving sleep mode with automatic wake-up on printer activity.
#
# Features:
#   - Hardware sleep mode via HTTP API (GC9A01 display sleep)
#   - ~85% power reduction (300mA â†’ ~50mA per display)
#   - Automatic wake on: homing, heating, probing, printing
#   - Multi-display support via mDNS (knomi-t0 through knomi-t5)
#   - Status tracking for display updates
#   - Retry logic for reliable wake/sleep commands
#
# Hardware Requirements:
#   - 6x BTT KNOMI displays with firmware v3.0+
#   - Network connectivity (displays reachable via mDNS)
#
# Structure:
#   1. Status Tracking Variables
#   2. Shell Commands (HTTP API)
#   3. Sleep/Wake Control Macros
#   4. G-Code Command Overrides
#   5. Helper & Debug Macros
#
# Integration:
#   - Works with idle_timeout for automatic sleep
#   - Overrides G28, M109, M190, BED_MESH_CALIBRATE
#
# Usage:
#   - KNOMI_SLEEP: Manually sleep all displays
#   - KNOMI_WAKE: Manually wake all displays
#   - CHECK_KNOMI_STATUS: Show current status flags
#
# ==============================================================================

# ==============================================================================
# SECTION 1: STATUS TRACKING VARIABLES
# ==============================================================================

[gcode_macro _KNOMI_STATUS]
description: Central status tracking for KNOMI display updates
# These variables control what information the displays show
# and trigger automatic wake-up when state changes occur
variable_displays_awake: True               # Track display sleep state (True = awake)
variable_homing: False                      # Currently homing axes
variable_probing: False                     # Currently probing bed
variable_qgling: False                      # Currently running QGL
variable_heating_nozzle: False              # Currently heating nozzle
variable_heating_bed: False                 # Currently heating bed
variable_printing: False                    # Currently printing
variable_paused: False                      # Print is paused
gcode:
    # No-op macro, only holds variables

# ==============================================================================
# SECTION 2: SHELL COMMANDS - HTTP API INTEGRATION
# ==============================================================================

# ------------------------------------------------------------------------------
# Simple Commands (No Retry) - Disabled by Default
# ------------------------------------------------------------------------------
# Faster but less reliable - use only if network is very stable
#[gcode_shell_command knomi_sleep_all]
#command: sh -c 'for i in 0 1 2 3 4 5; do curl -X POST http://knomi-t$i.local/api/sleep 2>/dev/null & done; wait'
#timeout: 10.0
#verbose: False

#[gcode_shell_command knomi_wake_all]
#command: sh -c 'for i in 0 1 2 3 4 5; do curl -X POST http://knomi-t$i.local/api/wake 2>/dev/null & done; wait'
#timeout: 10.0
#verbose: False

# ------------------------------------------------------------------------------
# Retry Commands - Active (Recommended)
# ------------------------------------------------------------------------------
# Sends commands to all 6 displays with retry logic for reliability
# Each display gets 3 attempts with 0.3s delay between retries

[gcode_shell_command knomi_sleep_all_retry]
# Put all KNOMI displays into hardware sleep mode (with retry)
# Command: Loop through all 6 displays (T0-T5), send sleep command with 3 retries
# mDNS names: knomi-t0.local through knomi-t5.local
# Timeout: 2s connect + 5s max time per attempt
command: sh -c 'for i in 0 1 2 3 4 5; do (for retry in 1 2 3; do curl -X POST --connect-timeout 2 --max-time 5 http://knomi-t$i.local/api/sleep 2>/dev/null && break || sleep 0.3; done) & done; wait'
timeout: 30.0                               # Total timeout for all operations
verbose: False                              # Suppress curl output

[gcode_shell_command knomi_wake_all_retry]
# Wake all KNOMI displays from hardware sleep (with retry)
# Command: Loop through all 6 displays (T0-T5), send wake command with 3 retries
# mDNS names: knomi-t0.local through knomi-t5.local
# Timeout: 2s connect + 5s max time per attempt
command: sh -c 'for i in 0 1 2 3 4 5; do (for retry in 1 2 3; do curl -X POST --connect-timeout 2 --max-time 5 http://knomi-t$i.local/api/wake 2>/dev/null && break || sleep 0.3; done) & done; wait'
timeout: 30.0                               # Total timeout for all operations
verbose: False                              # Suppress curl output

# ==============================================================================
# SECTION 3: SLEEP/WAKE CONTROL MACROS
# ==============================================================================

[gcode_macro KNOMI_SLEEP]
description: Put all KNOMI displays into hardware sleep mode
# Usage: KNOMI_SLEEP
# Called automatically by idle_timeout after 30 minutes of inactivity
# Uses state tracking to only send sleep command if displays are currently awake
gcode:
    {% set status = printer["gcode_macro _KNOMI_STATUS"] %}
    
    {% if status.displays_awake %}
        # Only send sleep command if displays are currently awake
        RESPOND MSG="ðŸ›Œ KNOMI: Displays entering sleep mode"
        RUN_SHELL_COMMAND CMD=knomi_sleep_all_retry
        
        # Update state: displays are now sleeping
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=displays_awake VALUE=False
        
        # Clear all status flags (displays are sleeping, no active state)
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=printing VALUE=False
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=paused VALUE=False
    {% else %}
        # Displays already sleeping, no action needed
        # (Silent - no console spam)
    {% endif %}

[gcode_macro KNOMI_WAKE]
description: Wake all KNOMI displays from hardware sleep
# Usage: KNOMI_WAKE
# Called automatically when printer becomes active (homing, heating, etc.)
# Uses state tracking to only send wake command if displays are currently sleeping
gcode:
    {% set status = printer["gcode_macro _KNOMI_STATUS"] %}
    
    {% if not status.displays_awake %}
        # Only send wake command if displays are currently sleeping
        RESPOND MSG="âš¡ KNOMI: Displays waking up"
        RUN_SHELL_COMMAND CMD=knomi_wake_all_retry
        
        # Update state: displays are now awake
        SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=displays_awake VALUE=True
    {% else %}
        # Displays already awake, no action needed
        # (Silent - no console spam)
    {% endif %}

# ==============================================================================
# SECTION 4: G-CODE COMMAND OVERRIDES
# ==============================================================================
# These macros override standard G-code commands to add automatic wake-up

# ------------------------------------------------------------------------------
# G28 - Homing Override
# ------------------------------------------------------------------------------
[gcode_macro G28]
description: Home axes with automatic KNOMI wake-up and status tracking
rename_existing: G28.1
gcode:
    KNOMI_WAKE                              # Wake displays
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True
    G28.1 {rawparams}                       # Execute original homing
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False

# ------------------------------------------------------------------------------
# M109 - Wait for Hotend Temperature Override
# ------------------------------------------------------------------------------
[gcode_macro M109]
description: Wait for nozzle temperature with automatic KNOMI wake-up
rename_existing: M109.1
gcode:
    KNOMI_WAKE                              # Wake displays
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=True
    M109.1 {rawparams}                      # Execute original command
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=False

# ------------------------------------------------------------------------------
# M190 - Wait for Bed Temperature Override
# ------------------------------------------------------------------------------
[gcode_macro M190]
description: Wait for bed temperature with automatic KNOMI wake-up
rename_existing: M190.1
gcode:
    KNOMI_WAKE                              # Wake displays
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=True
    M190.1 {rawparams}                      # Execute original command
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=False

# ------------------------------------------------------------------------------
# BED_MESH_CALIBRATE - Bed Probing Override
# ------------------------------------------------------------------------------
[gcode_macro BED_MESH_CALIBRATE]
description: Bed mesh calibration with automatic KNOMI wake-up
rename_existing: BTT_BED_MESH_CALIBRATE
gcode:
    KNOMI_WAKE                              # Wake displays
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True
    BTT_BED_MESH_CALIBRATE {rawparams}      # Execute original command
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False

# ==============================================================================
# SECTION 5: HELPER & DEBUG MACROS
# ==============================================================================

[gcode_macro CHECK_KNOMI_STATUS]
description: Display current KNOMI status flags for debugging
# Usage: CHECK_KNOMI_STATUS
# Shows all current status flags that control display behavior
gcode:
    {% set status = printer["gcode_macro _KNOMI_STATUS"] %}
    RESPOND MSG="===== KNOMI STATUS ====="
    RESPOND MSG="Displays Awake: {status.displays_awake}"
    RESPOND MSG="Homing: {status.homing}"
    RESPOND MSG="Probing: {status.probing}"
    RESPOND MSG="QGL-ing: {status.qgling}"
    RESPOND MSG="Heating Nozzle: {status.heating_nozzle}"
    RESPOND MSG="Heating Bed: {status.heating_bed}"
    RESPOND MSG="Printing: {status.printing}"
    RESPOND MSG="Paused: {status.paused}"
    RESPOND MSG="========================"

[gcode_macro KNOMI_RESET]
description: Reset all KNOMI status flags to default state
# Usage: KNOMI_RESET
# Clears all status flags and assumes displays are awake
# Useful after errors or manual intervention
gcode:
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=displays_awake VALUE=True
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=printing VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=paused VALUE=False
    RESPOND MSG="âœ… All KNOMI status flags have been reset"

# ==============================================================================
# INTEGRATION NOTES
# ==============================================================================
#
# Idle Timeout Integration:
#   The KNOMI_SLEEP macro is automatically called by [idle_timeout] in printer.cfg
#   after 30 minutes (1800s) of inactivity:
#
#   [idle_timeout]
#   timeout: 1800
#   gcode:
#       KNOMI_SLEEP      # Put displays to sleep
#       M84              # Disable stepper motors
#
# Quad Gantry Level Integration:
#   The QUAD_GANTRY_LEVEL macro in macros.cfg should include KNOMI_WAKE
#   and set the qgling status flag for proper display updates.
#
# Firmware Requirements:
#   All KNOMI displays must run firmware v3.0+ with HTTP API support:
#   - POST http://knomi-tX.local/api/sleep  (enter sleep mode)
#   - POST http://knomi-tX.local/api/wake   (exit sleep mode)
#
# Network Requirements:
#   - Displays must be reachable via mDNS (knomi-t0.local through knomi-t5.local)
#   - Stable WiFi connection recommended for reliable wake/sleep commands
#
# Power Savings:
#   - Active display: ~300mA per unit (1.8W @ 6 displays = 10.8W)
#   - Sleep mode: ~50mA per unit (0.3W @ 6 displays = 1.8W)
#   - Total savings: ~9W during idle periods
#
# ==============================================================================
