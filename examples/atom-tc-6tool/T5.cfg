# ==============================================================================
# VORON TOOLCHANGER — TOOLHEAD T5 CONFIGURATION
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Based on Viesturz's klipper-toolchanger configuration
# Original: https://github.com/viesturz/klipper-toolchanger
#
# Description:
#   Complete configuration for Toolhead 5 (T5) using BTT EBB36/42 CAN board.
#   Includes extruder, hotend, fans, sensors, and tool-specific parameters.
#   
#   ⚠️ SPECIAL NOTE: This toolhead has ADXL345 accelerometer ACTIVE for
#   resonance testing and input shaper calibration across all toolheads.
#
# Hardware:
#   - BTT EBB36/42 CAN board
#   - TMC2209 extruder driver with autotune
#   - ATC Semitec 104GT-2 thermistor
#   - Moons CSE14HRA1L410A extruder motor (50:8 geared)
#   - Filament runout sensor (switch-based)
#   - ADXL345 accelerometer (ACTIVE for resonance testing)
#
# Features:
#   - CAN bus communication
#   - Per-tool input shaper configuration
#   - Dynamic tool offset management (XYZ)
#   - Filament sensor integration
#   - Temperature monitoring and verification
#   - Individual hotend fan control
#   - Active accelerometer for system-wide resonance testing
#
# Structure:
#   1. CAN MCU Configuration
#   2. Temperature Monitoring
#   3. Extruder & Motor Driver
#   4. Heater Verification
#   5. Fans
#   6. Filament Sensors
#   7. Tool Macros & Parameters
#
# Initial Setup Required:
#   - Verify canbus_uuid matches your EBB board
#   - Calibrate extruder rotation_distance (extrusion test)
#   - Run PID tuning: PID_CALIBRATE HEATER=extruder5 TARGET=260
#   - Calibrate tool offsets (XY via NUDGE, Z via BEACON)
#   - Tune input shaper using active ADXL345
#
# Calibration Commands:
#   - PID_CALIBRATE HEATER=extruder5 TARGET=260
#   - DUMP_TMC STEPPER=extruder5
#   - QUERY_FILAMENT_SENSOR SENSOR=T5_filament_sensor
#   - ACCELEROMETER_QUERY (verify ADXL345 connection)
#   - MEASURE_AXES_NOISE (check accelerometer noise levels)
#
# ==============================================================================

# ==============================================================================
# SECTION 1: CAN MCU CONFIGURATION
# ==============================================================================

[mcu et5]
canbus_uuid: 5734e15d32b1                  # T5 - Update with your board's UUID
# Reference UUIDs for other toolheads:
#canbus_uuid: fd90506bc323                 # T0
#canbus_uuid: 27a86b72746b                 # T1
#canbus_uuid: 8e7342a0122a                 # T2
#canbus_uuid: a89b40936579                 # T3
#canbus_uuid: f7553e25a0a0                 # T4

# ------------------------------------------------------------------------------
# ADXL345 Accelerometer (ACTIVE for Resonance Testing)
# ------------------------------------------------------------------------------
# This accelerometer is used for input shaper tuning across all toolheads
# Commands:
#   - ACCELEROMETER_QUERY: Verify connection
#   - MEASURE_AXES_NOISE: Check noise levels
#   - SHAPER_CALIBRATE: Auto-calibrate input shaper
#   - TEST_RESONANCES AXIS=X: Test X-axis resonances
#   - TEST_RESONANCES AXIS=Y: Test Y-axis resonances

[adxl345]
cs_pin: et5:PB12
spi_software_sclk_pin: et5:PB10
spi_software_mosi_pin: et5:PB11
spi_software_miso_pin: et5:PB2
axes_map: x, y, z

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 20                           # Center point for resonance testing

# ==============================================================================
# SECTION 2: TEMPERATURE MONITORING
# ==============================================================================

[temperature_sensor T5]
sensor_type: temperature_mcu               # MCU temperature sensor
sensor_mcu: et5
min_temp: 0
max_temp: 100                              # Max safe MCU temperature

# ==============================================================================
# SECTION 3: EXTRUDER & MOTOR DRIVER
# ==============================================================================

# ------------------------------------------------------------------------------
# Extruder Configuration
# ------------------------------------------------------------------------------

[extruder5]
# Stepper pins
step_pin: et5:PD0
dir_pin: !et5:PD1
enable_pin: !et5:PD2

# Heater configuration
heater_pin: et5:PB13
sensor_type: ATC Semitec 104GT-2
sensor_pin: et5:PA3

# Stepper configuration
microsteps: 16
full_steps_per_rotation: 200               # 200 for 1.8°, 400 for 0.9° stepper
gear_ratio: 50:8                           # Extruder gear reduction (e.g., Sherpa Mini)

# Physical parameters
nozzle_diameter: 0.400
filament_diameter: 1.750

# Extrusion calibration
# IMPORTANT: Calibrate with 100mm extrusion test
# Formula: new_value = old_value * (100 / actual_extruded)
rotation_distance: 23.238341495348

# Safety limits
min_extrude_temp: 170                      # Minimum temp for extrusion
min_temp: 10
max_temp: 300
max_power: 1.0
max_extrude_cross_section: 50              # Maximum cross-section for flow
max_extrude_only_distance: 700.00          # Max extrusion without XYZ move

# Temperature control (PID tuned)
# Run: PID_CALIBRATE HEATER=extruder5 TARGET=260
control: pid
pid_Kp: 33.520
pid_Ki: 10.641
pid_Kd: 26.397

# Pressure advance
pressure_advance: 0                        # Set in slicer per-filament
pressure_advance_smooth_time: 0.040        # Smoothing window (default 0.04s)

# ------------------------------------------------------------------------------
# TMC2209 Motor Driver with Autotune
# ------------------------------------------------------------------------------

[tmc2209 extruder5]
uart_pin: et5:PA15
interpolate: false                         # Disable 256 microstep interpolation
run_current: 0.60                          # Running current (A)
# Alternative currents for different scenarios:
#run_current: 0.65                         # LGX Lite spool ACT NEMA14
#run_current: 0.75                         # LGX Lite drybox ACT NEMA14
#run_current: 0.80                         # LGX Lite fast infill 300 mm/s
#run_current: 0.90                         # LGX Lite >32 mm³/s ACT NEMA14
hold_current: 0.30                         # Holding current (A)
sense_resistor: 0.110                      # Current sense resistor value
stealthchop_threshold: 0                   # Disable StealthChop (use SpreadCycle)

[autotune_tmc extruder5]
motor: moons-cse14hra1l410a                # Motor model for autotuning
tuning_goal: auto                          # Auto-select tuning parameters
voltage: 24                                # Supply voltage

# Debug: Use DUMP_TMC STEPPER=extruder5 to inspect TMC registers

# ==============================================================================
# SECTION 4: HEATER VERIFICATION & SAFETY
# ==============================================================================

[verify_heater extruder5]
max_error: 120                             # Max temperature deviation (°C)
check_gain_time: 120                       # Time window for error checking (s)
hysteresis: 50                             # Allowed temperature swing (°C)
heating_gain: 2                            # Minimum heating rate (°C/s)

# ==============================================================================
# SECTION 5: FANS
# ==============================================================================

# ------------------------------------------------------------------------------
# Hotend Fan (Temperature-Controlled)
# ------------------------------------------------------------------------------

[heater_fan T5_hotend_fan]
pin: et5:PA1
heater: extruder5
heater_temp: 50.0                          # Turn on above 50°C
max_power: 1.0
kick_start_time: 0.5                       # Boost time for startup

# ------------------------------------------------------------------------------
# Part Cooling Fan
# ------------------------------------------------------------------------------
# Configured globally in printer.cfg (shared CPAP blower system)

# ------------------------------------------------------------------------------
# RGB Lighting
# ------------------------------------------------------------------------------
# LED effects managed via tc_led_effects.cfg
# Requires klipper-led_effect plugin

# ==============================================================================
# SECTION 6: FILAMENT SENSORS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Detection Sensor (Optional)
# ------------------------------------------------------------------------------

#[filament_switch_sensor tool5_detection]
#switch_pin: ^et5:PB9
#pause_on_runout: False
#runout_gcode:
#    M117 T5 disconnected
#insert_gcode:
#    M117 T5 connected

# ------------------------------------------------------------------------------
# Filament Runout Sensor (Active)
# ------------------------------------------------------------------------------

[filament_switch_sensor T5_filament_sensor]
switch_pin: et5:PB8
pause_on_runout: False                     # Don't auto-pause on runout
# Query sensor: QUERY_FILAMENT_SENSOR SENSOR=T5_filament_sensor
#runout_gcode:
#    M117 T5 Runout Detected
#insert_gcode:
#    M117 T5 Filament Loaded
#event_delay: 3.0
#pause_delay: 0.5

# ------------------------------------------------------------------------------
# Filament Motion Sensor (Optional)
# ------------------------------------------------------------------------------

#[filament_motion_sensor T5_motion_sensor]
#switch_pin: ^et5:PB3
#detection_length: 7.0
#extruder: extruder5
#pause_on_runout: False

# ==============================================================================
# SECTION 7: TOOL MACROS & PARAMETERS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Selection Macro
# ------------------------------------------------------------------------------

[gcode_macro T5]
description: Select Tool 5
variable_active: 0
gcode:
    SELECT_TOOL T=5
    _SET_ACTIVE_TOOL_FLAGS T=5

# ------------------------------------------------------------------------------
# Tool Parameters
# ------------------------------------------------------------------------------

[tool T5]
# Core configuration
tool_number: 5                             # Tool identifier (T5)
extruder: extruder5                        # Linked extruder
detection_pin: ^et5:PB9                    # Tool detection switch

# ------------------------------------------------------------------------------
# Tool Offsets (Managed Dynamically)
# ------------------------------------------------------------------------------
# These offsets are automatically managed by calibration macros:
# - XY offsets: Calibrated via NUDGE probe (calibrate_offsets.cfg)
# - Z offsets: Calibrated via BEACON contact (calibrate_offsets.cfg)
#
# DO NOT manually edit these unless recalibrating!
#gcode_x_offset: 0.00
#gcode_y_offset: 0.00
#gcode_z_offset: 0.00

# ------------------------------------------------------------------------------
# Relative Z-Offsets (T5 as Reference)
# ------------------------------------------------------------------------------
# Calibration values (commented during active use):
#t0_z_offset: 0.00000
#t1_z_offset: 0.00000
#t2_z_offset: 0.00000
#t3_z_offset: 0.00000
#t4_z_offset: 0.00000

# Active calibrated values:
#t0_z_offset: -0.10637
#t1_z_offset: -0.15825
#t2_z_offset: -0.22231
#t3_z_offset: -0.18387
#t4_z_offset: -0.10918

# ------------------------------------------------------------------------------
# Relative XY-Offsets (T5 as Reference)
# ------------------------------------------------------------------------------
# Calibration values (commented during active use):
#t0_xy_offset: 0.000000, 0.000000
#t1_xy_offset: 0.000000, 0.000000
#t2_xy_offset: 0.000000, 0.000000
#t3_xy_offset: 0.000000, 0.000000
#t4_xy_offset: 0.000000, 0.000000

# Active calibrated values:
#t0_xy_offset: -0.097000,  0.192000
#t1_xy_offset: -0.125000,  0.289000
#t2_xy_offset: -0.131000, -0.136000
#t3_xy_offset: -0.034000,  0.237000
#t4_xy_offset:  0.005000,  0.311000

# ------------------------------------------------------------------------------
# Tool Parking Position
# ------------------------------------------------------------------------------

params_park_x: 326.0                       # X dock position
params_park_y: 3.0                         # Y dock position
params_park_z: 325.0                       # Z dock position (safe height)

# ------------------------------------------------------------------------------
# Input Shaper Configuration (Per-Tool)
# ------------------------------------------------------------------------------

# X-axis shaper
params_input_shaper_type_x: 'ei'           # Shaper algorithm
params_input_shaper_freq_x: 79.2           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_x: 0.078 # Damping ratio

# Y-axis shaper
params_input_shaper_type_y: 'mzv'          # Shaper algorithm
params_input_shaper_freq_y: 42.2           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_y: 0.080 # Damping ratio
