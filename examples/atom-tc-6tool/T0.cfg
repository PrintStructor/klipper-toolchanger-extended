# ==============================================================================
# VORON TOOLCHANGER — TOOLHEAD T0 CONFIGURATION
# ==============================================================================
#
# ⚠️  WARNING: THIS CONFIG CONTAINS MY ACTUAL MACHINE VALUES!
# 
# YOU MUST CHANGE:
#   - CAN UUID (line ~70): canbus_uuid: fd90506bc323 ← YOUR UUID HERE
#   - Dock positions (line ~330): params_park_x/y/z ← YOUR POSITIONS
#   - PID values (line ~150): Run PID_CALIBRATE for YOUR hotend
#   - Input shaper (line ~350): Run resonance tests for YOUR frame
#   - Offsets (line ~300): Calibrate with NUDGE and BEACON for YOUR tools
#
# Find your CAN UUID:
#   ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
#
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Based on Viesturz's klipper-toolchanger configuration
# Original: https://github.com/viesturz/klipper-toolchanger
#
# Description:
#   Complete configuration for Toolhead 0 (T0) using BTT EBB36/42 CAN board.
#   Includes extruder, hotend, fans, sensors, and tool-specific parameters.
#
# Hardware:
#   - BTT EBB36/42 CAN board
#   - TMC2209 extruder driver with autotune
#   - ATC Semitec 104GT-2 thermistor
#   - Moons CSE14HRA1L410A extruder motor (50:8 geared)
#   - Filament runout sensor (switch-based)
#   - Optional ADXL345 accelerometer
#
# Features:
#   - CAN bus communication
#   - Per-tool input shaper configuration
#   - Dynamic tool offset management (XYZ)
#   - Filament sensor integration
#   - Temperature monitoring and verification
#   - Individual hotend fan control
#
# Structure:
#   1. CAN MCU Configuration
#   2. Temperature Monitoring
#   3. Extruder & Motor Driver
#   4. Heater Verification
#   5. Fans
#   6. Filament Sensors
#   7. Tool Macros & Parameters
#
# Initial Setup Required:
#   - Verify canbus_uuid matches your EBB board
#   - Calibrate extruder rotation_distance (extrusion test)
#   - Run PID tuning: PID_CALIBRATE HEATER=extruder TARGET=260
#   - Calibrate tool offsets (XY via NUDGE, Z via BEACON)
#   - Tune input shaper (optional ADXL345)
#
# Calibration Commands:
#   - PID_CALIBRATE HEATER=extruder TARGET=260
#   - DUMP_TMC STEPPER=extruder
#   - QUERY_FILAMENT_SENSOR SENSOR=T0_filament_sensor
#
# ==============================================================================

# ==============================================================================
# SECTION 1: CAN MCU CONFIGURATION
# ==============================================================================
[mcu et0]
canbus_uuid: fd90506bc323                  # T0 - Update with your board's UUID
# Reference UUIDs for other toolheads:
#canbus_uuid: 27a86b72746b                 # T1
#canbus_uuid: 8e7342a0122a                 # T2
#canbus_uuid: a89b40936579                 # T3
#canbus_uuid: f7553e25a0a0                 # T4
#canbus_uuid: 5734e15d32b1                 # T5

# ------------------------------------------------------------------------------
# Optional: ADXL345 Accelerometer (for Input Shaper tuning)
# ------------------------------------------------------------------------------
# Uncomment to enable on-board accelerometer for resonance testing
#[adxl345]
#cs_pin: et0:PB12
#spi_software_sclk_pin: et0:PB10
#spi_software_mosi_pin: et0:PB11
#spi_software_miso_pin: et0:PB2
#axes_map: x, z, -y

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    177.5, 177.5, 20                      # Center of bed at 20mm height

# ==============================================================================
# SECTION 2: TEMPERATURE MONITORING
# ==============================================================================

[temperature_sensor T0]
sensor_type: temperature_mcu               # MCU temperature sensor
sensor_mcu: et0
min_temp: 0
max_temp: 100                              # Max safe MCU temperature

# ==============================================================================
# SECTION 3: EXTRUDER & MOTOR DRIVER
# ==============================================================================

# ------------------------------------------------------------------------------
# Extruder Configuration
# ------------------------------------------------------------------------------

[extruder]
# Stepper pins
step_pin: et0:PD0
dir_pin: !et0:PD1
enable_pin: !et0:PD2

# Heater configuration
heater_pin: et0:PB13
sensor_type: ATC Semitec 104GT-2
sensor_pin: et0:PA3

# Stepper configuration
microsteps: 16
full_steps_per_rotation: 200               # 200 for 1.8°, 400 for 0.9° stepper
gear_ratio: 50:8                           # Extruder gear reduction (e.g., Sherpa Mini)

# Physical parameters
nozzle_diameter: 0.400
filament_diameter: 1.750

# Extrusion calibration
# IMPORTANT: Calibrate with 100mm extrusion test
# Formula: new_value = old_value * (100 / actual_extruded)
rotation_distance: 23.238341495348

# Safety limits
min_extrude_temp: 170                      # Minimum temp for extrusion
min_temp: 10
max_temp: 300
max_power: 1.0
max_extrude_cross_section: 50              # Maximum cross-section for flow
max_extrude_only_distance: 700.00          # Max extrusion without XYZ move

# Temperature control (PID tuned)
# Run: PID_CALIBRATE HEATER=extruder TARGET=260
control = pid
pid_Kp = 37.606
pid_Ki = 9.642
pid_Kd = 36.666

# Pressure advance
pressure_advance: 0                        # Set in slicer per-filament
pressure_advance_smooth_time: 0.040        # Smoothing window (default 0.04s)

# ------------------------------------------------------------------------------
# TMC2209 Motor Driver with Autotune
# ------------------------------------------------------------------------------

[tmc2209 extruder]
uart_pin: et0:PA15
interpolate: false                         # Disable 256 microstep interpolation
run_current: 0.60                          # Running current (A)
hold_current: 0.30                         # Holding current (A)
sense_resistor: 0.110                      # Current sense resistor value
stealthchop_threshold: 0                   # Disable StealthChop (use SpreadCycle)

[autotune_tmc extruder]
motor: moons-cse14hra1l410a                # Motor model for autotuning
tuning_goal: auto                          # Auto-select tuning parameters
voltage: 24                                # Supply voltage

# Debug: Use DUMP_TMC STEPPER=extruder to inspect TMC registers

# ==============================================================================
# SECTION 4: HEATER VERIFICATION & SAFETY
# ==============================================================================

[verify_heater extruder]
max_error: 120                             # Max temperature deviation (°C)
check_gain_time: 120                       # Time window for error checking (s)
hysteresis: 50                             # Allowed temperature swing (°C)
heating_gain: 2                            # Minimum heating rate (°C/s)

# ==============================================================================
# SECTION 5: FANS
# ==============================================================================

# ------------------------------------------------------------------------------
# Hotend Fan (Temperature-Controlled)
# ------------------------------------------------------------------------------
[heater_fan T0_hotend_fan]
pin: et0:PA1
heater: extruder
heater_temp: 50.0                          # Turn on above 50°C
max_power: 1.0
kick_start_time: 0.5                       # Boost time for startup

# ------------------------------------------------------------------------------
# Part Cooling Fan
# ------------------------------------------------------------------------------
# Configured globally in printer.cfg (shared CPAP blower system)

# ------------------------------------------------------------------------------
# RGB Lighting
# ------------------------------------------------------------------------------
# LED effects managed via tc_led_effects.cfg
# Requires klipper-led_effect plugin

# ==============================================================================
# SECTION 6: FILAMENT SENSORS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Detection Sensor (Optional)
# ------------------------------------------------------------------------------

#[filament_switch_sensor tool0_detection]
#switch_pin: ^et0:PB9
#pause_on_runout: False
#runout_gcode:
#    M117 T0 disconnected
#insert_gcode:
#    M117 T0 connected

# ------------------------------------------------------------------------------
# Filament Runout Sensor (Active)
# ------------------------------------------------------------------------------

[filament_switch_sensor T0_filament_sensor]
switch_pin: et0:PB8
pause_on_runout: False                     # Don't auto-pause on runout
# Query sensor: QUERY_FILAMENT_SENSOR SENSOR=T0_filament_sensor
#runout_gcode:
#    M117 T0 Runout Detected
#insert_gcode:
#    M117 T0 Filament Loaded
#event_delay: 3.0
#pause_delay: 0.5

# ------------------------------------------------------------------------------
# Filament Motion Sensor (Optional)
# ------------------------------------------------------------------------------
#[filament_motion_sensor T0_motion_sensor]
#switch_pin: ^et0:PB3
#detection_length: 7.0
#extruder: extruder
#pause_on_runout: False

# ==============================================================================
# SECTION 7: TOOL MACROS & PARAMETERS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Selection Macro
# ------------------------------------------------------------------------------

[gcode_macro T0]
description: Select Tool 0
variable_active: 0
gcode:
    SELECT_TOOL T=0
    _SET_ACTIVE_TOOL_FLAGS T=0

# ------------------------------------------------------------------------------
# Tool Parameters
# ------------------------------------------------------------------------------

[tool T0]
# Core configuration
tool_number: 0                             # Tool identifier (T0)
extruder: extruder                         # Linked extruder
detection_pin: ^et0:PB9                    # Tool detection switch

# ------------------------------------------------------------------------------
# Tool Offsets (Managed Dynamically)
# ------------------------------------------------------------------------------
# These offsets are automatically managed by calibration macros:
# - XY offsets: Calibrated via NUDGE probe (calibrate_offsets.cfg)
# - Z offsets: Calibrated via BEACON contact (calibrate_offsets.cfg)
#
# The offsets are stored in printer.cfg (SAVE_CONFIG section) and applied
# automatically during tool changes. Do NOT manually edit - use calibration!

# ------------------------------------------------------------------------------
# Tool Parking Position
# ------------------------------------------------------------------------------
params_park_x: 25.3                        # X dock position
params_park_y: 3.0                         # Y dock position
params_park_z: 325.0                       # Z dock position (safe height)

# ------------------------------------------------------------------------------
# Input Shaper Configuration (Per-Tool)
# ------------------------------------------------------------------------------
# X-axis shaper
params_input_shaper_type_x: 'ei'           # Shaper algorithm
params_input_shaper_freq_x: 79.8           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_x: 0.069 # Damping ratio

# Y-axis shaper
params_input_shaper_type_y: 'mzv'          # Shaper algorithm
params_input_shaper_freq_y: 42.6           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_y: 0.055 # Damping ratio
