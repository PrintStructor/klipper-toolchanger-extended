# ==============================================================================
# VORON TOOLCHANGER – OFFSET CALIBRATION SYSTEM
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 3.1
#
# Based on Viesturz's klipper-toolchanger calibration concepts
# Original: https://github.com/viesturz/klipper-toolchanger
#
# Description:
#   Complete calibration system for multi-tool toolchanger using:
#   - NUDGE Probe: Physical XY offset measurement between tools
#   - Beacon Contact: Z-offset measurement using nozzle contact detection
#
# Workflow:
#   1. XY Calibration: NUDGE_FIND_TOOL_OFFSETS (measures all tools vs initial)
#   2. Z Calibration:  MEASURE_TOOL_Z_OFFSETS (measures Z differences)
#   3. Save offsets:   SAVE_CONFIG (persists to printer.cfg)
#
# Prerequisites:
#   - NUDGE probe installed and configured (pin, spread, etc.)
#   - Beacon probe installed and calibrated
#   - Initial tool set: SET_INITIAL_TOOL TOOL=<n>
#
# ==============================================================================

# ==============================================================================
# SECTION 1: HARDWARE CONFIGURATION
# ==============================================================================

# ------------------------------------------------------------------------------
# TC Config Helper Module
# ------------------------------------------------------------------------------

[tc_config_helper]
# Provides TC_SAVE_CONFIG_VALUE command for saving calibration results
# This is used internally by calibration macros

# ------------------------------------------------------------------------------
# NUDGE Probe Configuration
# ------------------------------------------------------------------------------
# Physical contact probe for XY offset measurement

[tools_calibrate]
# Nudge config
#
# These two values should be changed or checked.
#
# 'pin' should reference the pin used for Nudge.
pin: PG10
# 'spread' is the amount of X or Y motion used in the probing sequence.
# Think of it as the clearance from the center, to accommodate the pin's diameter
# and any initial starting-point inaccuracy.
# For larger pins (5 mm), increase this to 3.5 mm+.
#   Increase this and/or improve the accuracy of the starting point if the probe triggers too early.
#   Decrease this and/or improve the accuracy of the starting point if motion
#   pushes your printer beyond the allowed travel amount.
#spread: 3
spread: 4
#
# Config below is unlikely to need changes.
#
# 'lower_z' is the distance below the probe tip in Z, used to ensure a hit.
# Increase this to have more of the nozzle contact during probing.
# Values as low as 0.1 mm may work and minimize overtravel.
lower_z: 0.2
travel_speed: 100
speed: 1.5
lift_speed: 4
final_lift_z: 6
sample_retract_dist: 2
samples_tolerance: 0.05
samples: 3                 # Try this if you get samples_tolerance errors with 5 samples
#samples: 5
samples_result: median     # median, average
trigger_to_bottom_z: 3
# If using a built-in Z probe to find the Nudge pin top, reference it here.
# This is only relevant for the flipped configuration, to provide resistance to pushing,
# for Tap/Boop/Poke/etc. Most users should leave this commented.
#probe: probe

[filament_switch_sensor nudge_tool]
# Filament sensor configuration for NUDGE probe
# Requires a [duplicate_pin_override] for this shared pin
switch_pin: PG10
pause_on_runout: false

# ==============================================================================
# SECTION 2: XY OFFSET CALIBRATION (NUDGE)
# ==============================================================================

# ------------------------------------------------------------------------------
# NUDGE Positioning Helper
# ------------------------------------------------------------------------------

[gcode_macro NUDGE_MOVE_OVER_PROBE]
description: Move toolhead to NUDGE probe location for XY calibration
# IMPORTANT: Update these coordinates after first successful probe!
# These values position the nozzle directly over the NUDGE pin
gcode:
  # Current calibrated position (adjust for your machine)
  G0 X127.552 F9000  # X position of NUDGE pin
  G0 Y354.373 F9000  # Y position of NUDGE pin
  G0 Z1.50           # Safe Z height above pin

# Previous values (for reference):
#  G0 X127.206 F9000
#  G0 Y352.847 F9000
#  G0 Z1.35

# ------------------------------------------------------------------------------
# Single Tool XY Calibration
# ------------------------------------------------------------------------------

[gcode_macro NUDGE_FIND_TOOL_OFFSET]
description: Calibrate XY offset for currently active tool (single tool)
# Usage: 
#   1. Heat nozzle to probe temp temperature (150°C-180°C)
#   2. Move near NUDGE probe
#   3. Run this macro
# 
# This macro is rarely used - NUDGE_FIND_TOOL_OFFSETS is preferred for batch calibration
gcode:
  NUDGE_MOVE_OVER_PROBE
  TOOL_LOCATE_SENSOR

# ------------------------------------------------------------------------------
# Batch XY Calibration (All Tools)
# ------------------------------------------------------------------------------

[gcode_macro NUDGE_FIND_TOOL_OFFSETS]
description: Calibrate XY offsets for all tools using NUDGE probe
# Usage: NUDGE_FIND_TOOL_OFFSETS INITIAL_TOOL=<0-5> [SKIP="2,3"] [RETURN=1]
#
# Parameters:
#   INITIAL_TOOL=<0-5> : Reference tool (all other tools measured relative to this)
#   SKIP="2,3"         : Optional - Skip specific tools (comma-separated)
#   RETURN=1           : Optional - Return to initial tool when complete (default: 0)
#
# Process:
#   1. Heats each tool to 180°C for consistent thermal expansion
#   2. Measures XY position of each nozzle relative to NUDGE pin
#   3. Calculates XY offsets relative to initial tool
#   4. Stores offsets in config (use SAVE_CONFIG to persist)
#
# Important:
#   - Run SET_INITIAL_TOOL TOOL=<n> before this macro
#   - Ensures global_z_offset is reset to 0.00 for clean calibration
#   - Takes ~15-20 minutes for 6 tools
gcode:
    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
    {% set PROBE_TEMP = 180 %}
    {% set TEMP_TOLERANCE = 5 %}
    {% set SKIP_TOOLS = params.SKIP|default("")|string %}
    {% set skip_list = SKIP_TOOLS.split(",") %}
    {% set RETURN_TO_INITIAL = params.RETURN|default(0)|int %}
    {% set BED_CENTER_X = 177.5 %}
    {% set BED_CENTER_Y = 177.5 %}
    {% set MAX_TOOLS = printer.toolchanger.params_max_tool_count|default(6)|int %}
    
    # Automatically reset global_z_offset to 0.00 for clean calibration
    {% set old_global_offset = printer["gcode_macro globals"].global_z_offset|float %}
    SET_GCODE_VARIABLE MACRO=globals VARIABLE=global_z_offset VALUE=0.00
    RESPOND TYPE=echo MSG="Global Z-offset reset: {old_global_offset} → 0.00 (for clean calibration)"
    
    # Note: Z-offsets are cleared in memory by TOOL_LOCATE_SENSOR (not saved to config)
      
    CHECK_HOMING
    G90
    G0 Z10 F1000
    
    # If we are already on the initial tool, go to bed center first
    {% if printer.toolchanger.tool %}
        {% if printer.toolchanger.tool.tool_number == INITIAL_TOOL %}
            G0 X{BED_CENTER_X} Y{BED_CENTER_Y} F6000
        {% else %}
            # Move current tool to bed center
            G0 X{BED_CENTER_X} Y{BED_CENTER_Y} F6000
            # Switch to the initial tool
            T{INITIAL_TOOL}
        {% endif %}
    {% else %}
        # No tool active, switch to the initial tool
        T{INITIAL_TOOL}
    {% endif %}
    
    # Heat the initial tool
    M109 S{PROBE_TEMP} T{INITIAL_TOOL}
    
    # Move to Nudge location and locate the sensor
    NUDGE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    
    # Set X–Y offsets to 0 for the initial tool
    SET_GCODE_OFFSET X=0 Y=0
    
    # Calibrate all other tools
    {% for tool in range(MAX_TOOLS) %}
        {% if tool != INITIAL_TOOL and tool|string not in skip_list %}
            # Return to bed center with the current tool
            G0 Z10 F1000
            G0 X{BED_CENTER_X} Y{BED_CENTER_Y} F6000
            
            # Tool change
            T{tool}
            
            # Preheat
            M104 S{PROBE_TEMP} T{tool}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={PROBE_TEMP - TEMP_TOLERANCE} MAXIMUM={PROBE_TEMP + TEMP_TOLERANCE}
            
            # Move to Nudge location
            NUDGE_MOVE_OVER_PROBE
            
            # Perform calibration
            TOOL_CALIBRATE_TOOL_OFFSET
            
            G4 P500
        {% endif %}
    {% endfor %}
    
    # Finish: return to bed center and turn heaters off
    G0 Z10 F1000
    G0 X{BED_CENTER_X} Y{BED_CENTER_Y} F6000
    TURN_OFF_HEATERS
    
    # Optionally return to the initial tool
    {% if RETURN_TO_INITIAL == 1 %}
        T{INITIAL_TOOL}
    {% endif %}
    
    M117 Calibration complete


# ==============================================================================
# SECTION 3: Z OFFSET CALIBRATION (BEACON)
# ==============================================================================

# ------------------------------------------------------------------------------
# Z Offset Measurement (Main Macro)
# ------------------------------------------------------------------------------

#[gcode_macro PRESERVE_XY_OFFSETS]
## Preserves existing XY offsets in configfile before saving new Z offsets
## This ensures XY offsets don't get lost when SAVE_CONFIG is executed
#gcode:
#    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
#    
#    RESPOND TYPE=echo MSG="Preserving existing XY offsets for all tools..."
#    
#    # Get the initial tool object to access xy_offsets
#    {% set initial_tool_name = "tool T" ~ INITIAL_TOOL %}
#    {% if initial_tool_name in printer %}
#        {% set xy_offsets = printer[initial_tool_name].xy_offsets %}
#        
#        # Save each XY offset using TC_SAVE_CONFIG_VALUE
#        {% set MAX_TOOLS = printer.toolchanger.params_max_tool_count|default(6)|int %}
#        {% for tool_num in range(MAX_TOOLS) %}
#            {% if tool_num != INITIAL_TOOL and tool_num in xy_offsets %}
#                {% set xy = xy_offsets[tool_num] %}
#                {% set x_val = xy[0]|float %}
#                {% set y_val = xy[1]|float %}
#                TC_SAVE_CONFIG_VALUE SECTION="{initial_tool_name}" OPTION="t{tool_num}_xy_offset" VALUE="{x_val},{y_val}"
#                RESPOND TYPE=echo MSG="Preserved XY offset for T{tool_num}: X={x_val}, Y={y_val}"
#            {% endif %}
#        {% endfor %}
#    {% else %}
#        RESPOND TYPE=echo MSG="Warning: Initial tool {initial_tool_name} not found in printer object"
#    {% endif %}

[gcode_macro MEASURE_TOOL_Z_OFFSETS]
description: Measure Z-offsets between tools using Beacon contact detection
# Usage: MEASURE_TOOL_Z_OFFSETS INITIAL_TOOL=<0-5>
#
# Parameters:
#   INITIAL_TOOL=<0-5> : Reference tool for Z measurements
#
# Process:
#   1. Heats each tool to 180°C for consistent thermal expansion
#   2. Uses Beacon contact mode to measure nozzle height
#   3. Calculates Z-offset difference from initial tool
#   4. Stores offsets via shell scripts (persisted automatically)
#
# Prerequisites:
#   - XY offsets must be calibrated first (NUDGE_FIND_TOOL_OFFSETS)
#   - Run SET_INITIAL_TOOL TOOL=<n> before this macro
#   - Beacon probe must be calibrated
#
# Important:
#   - Enables calibration_mode (disables offset application during measurement)
#   - Ensures global_z_offset is 0.00 during calibration
#   - Takes ~15-20 minutes for 6 tools
gcode:
    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
    {% set PROBE_TEMP = 180 %}
    {% set TEMP_TOLERANCE = 5 %}
    {% set X_POS = 177.5 %}
    {% set Y_POS = 177.5 %}

    # Verify global_z_offset is 0.00 for clean calibration
    {% set current_global = printer["gcode_macro globals"].global_z_offset|float %}
    {% if current_global != 0.0 %}
        SET_GCODE_VARIABLE MACRO=globals VARIABLE=global_z_offset VALUE=0.00
        RESPOND TYPE=echo MSG="WARNING: Global Z-offset was {current_global}, reset to 0.00"
    {% else %}
        RESPOND TYPE=echo MSG="Global Z-offset is 0.00 - ready for calibration"
    {% endif %}

    M117 Starting tool z-offset calibration
    RESPOND TYPE=echo MSG="Starting tool z-offset calibration with T{INITIAL_TOOL} as initial tool"
    
    # Enable calibration mode to disable Z-offset application during measurements
    SET_GCODE_VARIABLE MACRO=globals VARIABLE=toolchanger_calibration_mode VALUE=1
    {% set toolchanger = printer.toolchanger %}
    {% if toolchanger %}
        # Python side doesn't see gcode_macro variables immediately, so we set it directly via a custom command
        _SET_CALIBRATION_MODE ENABLE=1
    {% endif %}
    
    # Set the initial tool in globals for SAVE_TOOL_Z_OFFSET to use
    SET_GCODE_VARIABLE MACRO=globals VARIABLE=current_tool VALUE={INITIAL_TOOL}
    
    G90
    G0 Z10 F1000

    # Initial tool setup
    T{INITIAL_TOOL}
    {% if INITIAL_TOOL == 0 %}
        {% set sensor_name = "extruder" %}
    {% else %}
        {% set sensor_name = "extruder" ~ INITIAL_TOOL %}
    {% endif %}
    {% if INITIAL_TOOL == 0 %}
        M109 S{PROBE_TEMP}                  # Heat extruder
    {% else %}
        M109 S{PROBE_TEMP} T{INITIAL_TOOL}  # Heat extruder{INITIAL_TOOL}
    {% endif %}
    TEMPERATURE_WAIT SENSOR={sensor_name} MINIMUM={PROBE_TEMP - TEMP_TOLERANCE} MAXIMUM={PROBE_TEMP + TEMP_TOLERANCE}
    
    # SET_GCODE_OFFSET X=0 Y=0  # Keep XY offsets so all tools measure at the same physical location
    SET_GCODE_OFFSET Z=0 MOVE=1
    
    # Move to bed center for Beacon measurements
    G0 X{X_POS} Y{Y_POS} F5000
    
    # Initial tool measurement - set Z reference with Beacon contact
    RESPOND TYPE=echo MSG="Measuring initial tool T{INITIAL_TOOL} as reference"
    G28 Z METHOD=CONTACT
    
    # Initial tool has NO z-offset to itself (it's the reference point)
    RESPOND TYPE=echo MSG="Initial tool T{INITIAL_TOOL} is the reference (no z-offset to itself)"
    G0 Z10 F1000
    
    # Measure all other tools
    {% set MAX_TOOLS = printer.toolchanger.params_max_tool_count|default(6)|int %}
    {% for tool in range(MAX_TOOLS) %}
        {% if tool != INITIAL_TOOL %}
            M117 Calibrating T{tool}
            RESPOND TYPE=echo MSG="Calibrating T{tool}"

            # Tool change and heating
            G0 Z10 F1000
            T{tool}

            # Select correct temperature sensor
            {% if tool == 0 %}
                {% set sensor_name = "extruder" %}
            {% else %}
                {% set sensor_name = "extruder" ~ tool %}
            {% endif %}
            {% if tool == 0 %}
                M109 S{PROBE_TEMP}            # Heat extruder
            {% else %}
                M109 S{PROBE_TEMP} T{tool}    # Heat extruder{tool}
            {% endif %}
            TEMPERATURE_WAIT SENSOR={sensor_name} MINIMUM={PROBE_TEMP - TEMP_TOLERANCE} MAXIMUM={PROBE_TEMP + TEMP_TOLERANCE}
            
            # SET_GCODE_OFFSET X=0 Y=0  # Keep XY offsets so all tools measure at the same physical location
            G0 X{X_POS} Y{Y_POS} F5000
            
            # Beacon Messung mit Marker durchführen
            TC_BEACON_COMPARE TOOL={tool}
            
            # Python-Script parst gcode_store und schreibt Wert in /tmp/beacon_contact_tX.txt
            RUN_SHELL_COMMAND CMD=capture_beacon_contact PARAMS="{tool}"
            
            # Bash-Script liest Datei und speichert via Moonraker API
            RUN_SHELL_COMMAND CMD=save_beacon_contact PARAMS="{tool}"
        {% endif %}
    {% endfor %}

    # Finalization
    G0 Z10 F1000
    T{INITIAL_TOOL}
    # Turn off all heaters
    {% for tool in range(MAX_TOOLS) %}
        {% if tool == 0 %}
            M104 S0                 # Turn off extruder
        {% else %}
            M104 S0 T{tool}         # Turn off extruder{tool}
        {% endif %}
    {% endfor %}
    
    # Disable calibration mode
    _SET_CALIBRATION_MODE ENABLE=0
    SET_GCODE_VARIABLE MACRO=globals VARIABLE=toolchanger_calibration_mode VALUE=0
    
    M117 Calibration complete!
    RESPOND TYPE=echo MSG="Tool z-offset calibration complete. Run SAVE_CONFIG to store permanently."

# ------------------------------------------------------------------------------
# Beacon Helper Scripts & Macros
# ------------------------------------------------------------------------------

[gcode_shell_command capture_beacon_contact]
# Python script: Parses Beacon contact measurement from gcode_store
# Creates /tmp/beacon_contact_tX.txt with measured Z value
command: /home/pi/klipper-toolchanger/klipper/extras/tc_beacon_capture.py
timeout: 10.0
verbose: True

[gcode_shell_command save_beacon_contact]
# Bash script: Reads temp file and saves Z-offset via Moonraker API
# Persists offset to printer config automatically
command: /home/pi/klipper-toolchanger/klipper/extras/tc_save_beacon_contact.sh
timeout: 5.0
verbose: True

[gcode_macro TC_BEACON_COMPARE]
description: Wrapper for BEACON_OFFSET_COMPARE with machine-readable marker
# Internal macro called by MEASURE_TOOL_Z_OFFSETS
# Performs Beacon measurement and outputs parseable marker for scripts
variable_tool: -1
variable_last_contact: 0.0
gcode:
    {% set TOOL = params.TOOL|default(-1)|int %}
    
    {% if TOOL >= 0 %}
        SET_GCODE_VARIABLE MACRO=TC_BEACON_COMPARE VARIABLE=tool VALUE={TOOL}
    {% endif %}
    
    # Beacon Messung durchführen
    BEACON_OFFSET_COMPARE SAMPLES=10
    
    # Eindeutiger Marker für Moonraker gcode_store Parsing
    # Verwende params.TOOL direkt, da SET_GCODE_VARIABLE nicht sofort wirksam ist
    RESPOND TYPE=command MSG="TC_BEACON_MARKER: tool={TOOL}"
