# ==============================================================================
# VORON TOOLCHANGER ‚Äî CORE OPERATION & UTILITY MACROS
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
#
# Description:
#   This file contains essential macros for toolchanger operation, including:
#   - Core: Global variables and initial tool setup
#   - Utilities: Filament sensor control, demo functions, tool monitoring
#
# Usage:
#   1. Set your initial tool before printing: SET_INITIAL_TOOL TOOL=0
#   2. Use T0-T5 commands to switch tools during printing
#   3. For calibration workflows, see calibrate_offsets.cfg
#
# ==============================================================================

# ==============================================================================
# SECTION 1: CORE OPERATIONS
# ==============================================================================

# ------------------------------------------------------------------------------
# Internal Helper: Set Active Tool Flags
# ------------------------------------------------------------------------------
# NOTE: This may be deprecated if the toolchanger module handles this internally
# Status: LEGACY - Keep for backward compatibility, may be removed in future

[gcode_macro _SET_ACTIVE_TOOL_FLAGS]
description: Helper macro ‚Äì sets the variable_active flags for T0..T5
# Usage: _SET_ACTIVE_TOOL_FLAGS T=<0..5>
gcode:
  {% set t = params.T|int %}
  SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE={1 if t==0 else 0}
  SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE={1 if t==1 else 0}
  SET_GCODE_VARIABLE MACRO=T2 VARIABLE=active VALUE={1 if t==2 else 0}
  SET_GCODE_VARIABLE MACRO=T3 VARIABLE=active VALUE={1 if t==3 else 0}
  SET_GCODE_VARIABLE MACRO=T4 VARIABLE=active VALUE={1 if t==4 else 0}
  SET_GCODE_VARIABLE MACRO=T5 VARIABLE=active VALUE={1 if t==5 else 0}

# ------------------------------------------------------------------------------
# Global Variables Storage
# ------------------------------------------------------------------------------
# ESSENTIAL: Central storage for toolchanger state and offsets
# These variables persist across tool changes and are used by multiple macros

[gcode_macro globals]
description: Central storage for toolchanger state and offset values
# Tool tracking
variable_current_initial_tool: -1           # Initially selected tool (-1 = none set)
variable_current_tool: -1                   # Currently active tool number

# Z-offset configuration
variable_global_z_offset: 0.06              # Base Z-offset applied to initial tool
# Note: Adjust global_z_offset based on your Beacon calibration results
# Typical values: 0.06-0.12mm depending on nozzle characteristics

# Calibration mode control
variable_toolchanger_calibration_mode: 0    # 0 = normal operation (offsets active)
                                            # 1 = calibration mode (offsets disabled)

# NOTE: Individual tool Z-offsets are managed by the toolchanger module itself
# and stored directly in printer.cfg under [tool T0] through [tool T5] sections.
# No manual variables needed here.

gcode:
    RESPOND TYPE=echo MSG="Global toolchanger variables initialized"

# ------------------------------------------------------------------------------
# Initial Tool Setup
# ------------------------------------------------------------------------------
# ESSENTIAL: Must be called before printing to establish the reference tool

[gcode_macro SET_INITIAL_TOOL]
description: Define the initial tool as the Z-offset reference point
# Usage: SET_INITIAL_TOOL TOOL=<0-5> [FORCE_SWITCH=1]
# 
# Parameters:
#   TOOL=<0-5>      : Tool number to set as initial reference
#   FORCE_SWITCH=1  : Optional - Force switch if another tool is active
#
# Purpose:
#   - Establishes the reference tool for all Z-offset measurements
#   - Sets XY offsets to 0,0 for the initial tool
#   - Applies global_z_offset to compensate for nozzle height
#   - Must be called before starting a print
#
# Safety:
#   - Prevents accidental switches when a tool is already active
#   - Use FORCE_SWITCH=1 only if you're certain it's safe to switch
gcode:
    {% set TOOL = params.TOOL|default(-1)|int %}
    {% set FORCE_SWITCH = params.FORCE_SWITCH|default(0)|int %}
    
    {% if TOOL < 0 %}
        RESPOND TYPE=error MSG="Error: Please specify a valid tool number using TOOL=X"
    {% elif printer.toolchanger.tool_number >= 0 and printer.toolchanger.tool_number != TOOL %}
        # Another tool is already active
        {% if FORCE_SWITCH == 1 %}
            # Force switch to the new initial tool
            RESPOND MSG="‚ö†Ô∏è Switching from T{printer.toolchanger.tool_number} to T{TOOL} as new initial tool"
            SET_GCODE_VARIABLE MACRO=globals VARIABLE=current_tool VALUE={TOOL}
            RESET_INITIAL_TOOL
            SELECT_TOOL T={TOOL}
            RELOAD_TOOL_OFFSETS TOOL={TOOL}
            RESPOND MSG="‚úÖ Set T{TOOL} as new initial tool and reloaded offsets"
        {% else %}
            # Issue warning and do NOT switch (safe!)
            RESPOND TYPE=error MSG="‚ö†Ô∏è WARNING: T{printer.toolchanger.tool_number} is already active!"
            RESPOND TYPE=error MSG="To set T{TOOL} as the new initial tool, you have two options:"
            RESPOND TYPE=error MSG="1. First perform a tool change: SELECT_TOOL T={TOOL}"
            RESPOND TYPE=error MSG="2. Use FORCE_SWITCH=1 to switch automatically"
            RESPOND TYPE=error MSG="Example: SET_INITIAL_TOOL TOOL={TOOL} FORCE_SWITCH=1"
        {% endif %}
    {% else %}
        # No tool active or same tool ‚Üí safe
        SET_GCODE_VARIABLE MACRO=globals VARIABLE=current_tool VALUE={TOOL}
        {% if printer.toolchanger.tool_number < 0 %}
            # Toolchanger not yet initialized
            INITIALIZE_TOOLCHANGER TOOL="tool T{TOOL}"
        {% endif %}
        RELOAD_TOOL_OFFSETS TOOL={TOOL}
        # Direkt alle Offsets f√ºr Initial-Tool setzen (XY=0, Z=global)
        {% set global_offset = printer["gcode_macro globals"].global_z_offset|float %}
        SET_GCODE_OFFSET X=0 Y=0 Z={global_offset} ABSOLUTE=1
        RESPOND MSG="‚úÖ Set T{TOOL} as initial tool with offsets X=0 Y=0 Z={global_offset}"
    {% endif %}

# ==============================================================================
# SECTION 2: UTILITY FUNCTIONS
# ==============================================================================

# ------------------------------------------------------------------------------
# Filament Sensor Control
# ------------------------------------------------------------------------------
# ESSENTIAL: Enable/disable filament sensors during tool changes

[gcode_macro _ENABLE_FILAMENT_SENSORS]
description: Enable all filament sensors for T0-T5
# Internal helper called during tool changes
gcode:
        SET_FILAMENT_SENSOR SENSOR=T0_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T1_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T2_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T3_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T4_filament_sensor ENABLE=1
        SET_FILAMENT_SENSOR SENSOR=T5_filament_sensor ENABLE=1

[gcode_macro _DISABLE_FILAMENT_SENSORS]
description: Disable all filament sensors for T0-T5
# Internal helper called during tool changes to prevent false triggers
gcode:
        # Disable all tool filament sensors
        SET_FILAMENT_SENSOR SENSOR=T0_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T1_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T2_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T3_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T4_filament_sensor ENABLE=0
        SET_FILAMENT_SENSOR SENSOR=T5_filament_sensor ENABLE=0

[gcode_macro TOGGLE_FILAMENT_SENSORS]
description: Toggle filament sensor state on or off
# Usage: TOGGLE_FILAMENT_SENSORS ENABLE=1 (enable) or ENABLE=0 (disable)
#
# Purpose:
#   Manual control of all filament sensors at once
#   Useful for testing or maintenance procedures
gcode:
    {% if params.ENABLE is defined %}
        {% if params.ENABLE|int == 1 %}
            _ENABLE_FILAMENT_SENSORS
            RESPOND MSG="All filament sensors enabled"
        {% else %}
            _DISABLE_FILAMENT_SENSORS
            RESPOND MSG="All filament sensors disabled"
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="Please specify ENABLE=1 or ENABLE=0"
    {% endif %}

# ------------------------------------------------------------------------------
# Demo and Testing Functions
# ------------------------------------------------------------------------------

[gcode_macro TOOLCHANGE_DEMO]
description: Demo macro ‚Äì randomly switches tools 20 times for testing
# WARNING: Only use when printer is in a safe state!
# Purpose: Test toolchanger reliability and timing
gcode:
    RESPOND MSG="Starting toolchange demo - 20 random tool switches"
    {% for n in range(20) %}
      T{ printer.toolchanger.tool_numbers | random }
      G4 P500  # Brief pause between changes
    {% endfor %}
    RESPOND MSG="Toolchange demo complete"

# ------------------------------------------------------------------------------
# Tool Presence Monitor (Continuous Detection)
# ------------------------------------------------------------------------------
# CRITICAL: Monitors active tool presence during printing
# Automatically pauses if tool drops during operation

[delayed_gcode TOOL_PRESENCE_MONITOR]
initial_duration: 0  # Started manually by PRINT_START
gcode:
    {% if printer.print_stats.state == "printing" %}
        {% set tc_status = printer.toolchanger.status|lower %}
        {% set current_tool_number = printer.toolchanger.tool_number %}
        
        # Only monitor when toolchanger is ready and a tool is active
        {% if tc_status == "ready" and current_tool_number >= 0 %}
            # Get the actual tool object by number
            {% set tool_name = "tool T" + current_tool_number|string %}
            {% set tool_obj = printer[tool_name] %}
            
            # Check detect_state directly (1=PRESENT, 0=ABSENT, -1=UNAVAILABLE)
            {% if tool_obj.detect_state != 1 %}
                # üö® CRITICAL: Tool has dropped! (detect_state is 0 or -1)
                RESPOND TYPE=error MSG="üö® CRITICAL: T{current_tool_number} has dropped during printing!"
                RESPOND TYPE=error MSG="detect_state = {tool_obj.detect_state} (0=ABSENT, 1=PRESENT, -1=UNAVAILABLE)"
                
                # Save current target temperature before turning heater off
                {% set extruder_name = tool_obj.extruder %}
                {% set current_target = printer[extruder_name].target|float %}
                SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_target VALUE={current_target}
                
                # SAFETY: Turn off lost tool's heater immediately (prevents fire hazard)
                M104 S0 T{current_tool_number}
                
                PAUSE
                M117 Tool T{current_tool_number} lost!
                
                # Set LED status to error if available
                {% if "STATUS_ERROR" in printer.gcode %}
                    STATUS_ERROR
                {% endif %}
                
                # Stop monitoring until issue is resolved
                UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=0
            {% else %}
                # Tool OK (detect_state = 1), continue monitoring
                UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=2.0
            {% endif %}
        {% else %}
            # Toolchange in progress, error state, or no tool active - skip check and retry
            UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=2.0
        {% endif %}
    {% else %}
        # Not printing, pause monitoring
        UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=10.0
    {% endif %}
