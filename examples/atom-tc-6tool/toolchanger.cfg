# ==============================================================================
# VORON TOOLCHANGER — MAIN CONFIGURATION
# ==============================================================================
#
# ⚠️  WARNING: THIS CONFIG CONTAINS MY MACHINE-SPECIFIC VALUES!
#
# CRITICAL VALUES TO ADJUST FOR YOUR MACHINE:
#   - params_safe_y (line ~65): Y position for safe horizontal moves ← YOUR VALUE
#   - params_close_y (line ~66): Y position close to dock area ← YOUR VALUE
#   - Dock paths may need adjustment depending on your physical setup
#   - Z-stepper currents (bottom of file) must match YOUR TMC drivers
#
# These values work for MY VORON 350mm with specific dock positions.
# Test movements SLOWLY first with params_fast_speed: 2700 (45mm/s)
#
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Based on Viesturz's klipper-toolchanger configuration
# Original: https://github.com/viesturz/klipper-toolchanger
#
# Description:
#   Core toolchanger configuration for 6-tool VORON setup with ATOM dock system.
#   Defines docking paths, initialization, safety logic, and tool change sequences.
#
# Features:
#   - Multi-path dock support (ATOM, PAD, ROD, HOOK-ON, XOL)
#   - Rounded motion paths via ROUNDED_G0 for smooth movements
#   - Two-stage pickup with verification between stages
#   - Automatic axis homing and safety moves
#   - Per-tool Input Shaper configuration
#   - Z-stepper current boost during tool changes
#   - Temperature handling with wait-to-target
#
# Structure:
#   1. Rounded Path Module
#   2. Toolchanger Core Configuration
#   3. Tool Change Sequences (pickup/dropoff)
#   4. Archived Code (for reference)
#   5. Helper Macros & Overrides (M104/M109, Z-current, etc.)
#
# Important Notes:
#   - All coordinates must be tuned for your specific dock layout
#   - Individual tool configs (T0.cfg - T5.cfg) define park positions and offsets
#   - Verification is enabled - tool detection must work reliably
#
# ==============================================================================

# ==============================================================================
# SECTION 1: ROUNDED PATH MODULE
# ==============================================================================

[rounded_path]
# Enables smooth curved movements between waypoints
# Lower resolution = smoother curves but more processing
resolution: 1.0

# ==============================================================================
# SECTION 2: TOOLCHANGER CORE CONFIGURATION
# ==============================================================================

[toolchanger]
# ------------------------------------------------------------------------------
# Basic Settings
# ------------------------------------------------------------------------------
verify_tool_pickup: true                    # Enable tool detection verification
t_command_restore_axis: z                   # Restore Z position after tool change
#t_command_restore_axis: xyz                # Restore XYZ position after tool change
params_max_tool_count: 6                    # Number of tools (change to 7 for 7-tool setup)

# ------------------------------------------------------------------------------
# Movement Parameters
# ------------------------------------------------------------------------------
params_safe_y: 105                          # Y position for safe horizontal moves
params_close_y: 35                          # Y position close to dock area
params_fast_speed: 27000                    # Fast travel speed: 450 mm/s @ 1000 mm/s²
params_path_speed: 3000                     # Docking path speed: 50 mm/s
# Testing values (uncomment for slower debugging):
#params_fast_speed: 2700                    # 45 mm/s for testing
#params_path_speed: 300                     # 5 mm/s for testing

# ------------------------------------------------------------------------------
# Dock Path Definitions
# ------------------------------------------------------------------------------
# Format: [{'y':Y_offset, 'z':Z_offset, 'f':speed_multiplier}, ...]
# - Offsets are relative to tool park position
# - 'f' parameter marks verification point (where tool detection is checked)
# - Paths are executed in reverse during pickup

params_type = 'atom_dock'                   # Active dock type for this setup

# ATOM Dock: Simple 4-point path
params_atom_dock_path: [{'y':9, 'z':1},{'y':8, 'z':0.5, 'f':0.5}, {'y':0, 'z':0.5}, {'y':0, 'z':-10}]

# PADS Mini: 7-point path with gradual release
params_pads_mini_path: [{'y':9 ,'z':2}, {'y':8, 'z':0}, {'y':0, 'z':0, 'f':0.5},{'y':0, 'z':-5}, {'y':1, 'z':-7}, {'y':3, 'z':-9}, {'y':7,'z':-11}]

# PADS Stealthburner: Extended path with high clearance
params_pads_sb_path: [{'y':9.5 ,'z':8}, {'y':9.5, 'z':2}, {'y':5.5, 'z':0}, {'y':0, 'z':0, 'f':0.5},{'y':0, 'z':-5}, {'y':1, 'z':-7}, {'y':3, 'z':-9}, {'y':7,'z':-11}]

# RODS Mini: 5-point path
params_rods_mini_path: [{'z':0, 'y':4}, {'z':0, 'y':0, 'f':0.5}, {'z':-6, 'y':0}, {'z':-10, 'y':3}, {'z':-10, 'y':16}]

# RODS Stealthburner: Combined approach with high clearance
params_rods_sb_path: [{'y':9.5 ,'z':8}, {'y':9.5, 'z':2}, {'y':5.5, 'z':0}, {'z':0, 'y':0, 'f':0.5}, {'z':-6, 'y':0}, {'z':-10, 'y':3}, {'z':-10, 'y':16}]

# RODS Mini Hook-On: Modified path for hook mechanism
params_rods_mini_hookon_path: [{'z':0, 'y':4}, {'z':0, 'y':0, 'f':0.5}, {'z':-7.3, 'y':0}, {'z':-12.3, 'y':3.5}, {'z':-12.3, 'y':16}]

# RODS XOL: Extended 9-point path
params_rods_xol_path: [{'y':59, 'z':17.5},{'y':5, 'z':17.5},{'y':5, 'z':0.2},{'y':0.5, 'z':0.1},{'z':0, 'y':0, 'f':0.5},{'z':-5, 'y':0},{'z':-6, 'y':3},{'z':-8, 'y':7},{'z':-10, 'y':16}]

# ------------------------------------------------------------------------------
# Initialization Behavior
# ------------------------------------------------------------------------------
#initialize_on: manual                      # Require manual initialization (safe default)
initialize_on: first-use                    # Auto-initialize on first tool command

uses_axis: xyz                              # Toolchanger uses all three axes
on_axis_not_homed: home                     # Auto-home if axes not homed

# ------------------------------------------------------------------------------
# Initialization GCode
# ------------------------------------------------------------------------------
# Executed once when toolchanger is first initialized
# Ensures machine is homed and in a safe state

initialize_gcode:
    # Home X and Y if not already homed
    {% if not 'x' in printer.toolhead.homed_axes %}
        G28 X
    {% endif %}
    {% if not 'y' in printer.toolhead.homed_axes %}
        G28 Y
    {% endif %}
    # Move to bed center for safety
    G90
    G0 X175 Y175 F6000
    # Optional: Auto-detect and initialize from current tool
    #_INITIALIZE_FROM_DETECTED_TOOL

# ------------------------------------------------------------------------------
# Before/After Tool Change Hooks
# ------------------------------------------------------------------------------

before_change_gcode:
    # Executed before starting a tool change
    # Currently just stores tool number for reference
    {% set tn = "T"+(tool.tool_number|string) %}

after_change_gcode:
    # Executed after completing a tool change
    # Applies per-tool Input Shaper configuration
    {% set tn = "T"+(tool.tool_number|string) %}
    
    # Load Input Shaper parameters from tool-specific config
    # Checks both 'input_shaper_*' and 'params_input_shaper_*' for compatibility
    {% set shaper_type_x = tool.input_shaper_type_x if tool.input_shaper_type_x is defined else tool.params_input_shaper_type_x if tool.params_input_shaper_type_x is defined else None %}
    {% set shaper_type_y = tool.input_shaper_type_y if tool.input_shaper_type_y is defined else tool.params_input_shaper_type_y if tool.params_input_shaper_type_y is defined else None %}
    {% set shaper_freq_x = tool.input_shaper_freq_x if tool.input_shaper_freq_x is defined else tool.params_input_shaper_freq_x if tool.params_input_shaper_freq_x is defined else None %}
    {% set shaper_freq_y = tool.input_shaper_freq_y if tool.input_shaper_freq_y is defined else tool.params_input_shaper_freq_y if tool.params_input_shaper_freq_y is defined else None %}
    {% set damping_ratio_x = tool.input_shaper_damping_ratio_x if tool.input_shaper_damping_ratio_x is defined else tool.params_input_shaper_damping_ratio_x if tool.params_input_shaper_damping_ratio_x is defined else 0.1 %}
    {% set damping_ratio_y = tool.input_shaper_damping_ratio_y if tool.input_shaper_damping_ratio_y is defined else tool.params_input_shaper_damping_ratio_y if tool.params_input_shaper_damping_ratio_y is defined else 0.1 %}

    # Fallback to global toolchanger parameters if tool-specific not found
    {% if shaper_type_x is none %}{% set shaper_type_x = toolchanger.input_shaper_type_x %}{% endif %}
    {% if shaper_type_y is none %}{% set shaper_type_y = toolchanger.input_shaper_type_y %}{% endif %}
    {% if shaper_freq_x is none %}{% set shaper_freq_x = toolchanger.input_shaper_freq_x %}{% endif %}
    {% if shaper_freq_y is none %}{% set shaper_freq_y = toolchanger.input_shaper_freq_y %}{% endif %}

    # Apply Input Shaper configuration only if all parameters are valid
    {% if shaper_type_x and shaper_type_y and shaper_freq_x and shaper_freq_y %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={shaper_type_x} SHAPER_TYPE_Y={shaper_type_y} SHAPER_FREQ_X={shaper_freq_x} SHAPER_FREQ_Y={shaper_freq_y} DAMPING_RATIO_X={damping_ratio_x} DAMPING_RATIO_Y={damping_ratio_y}
    {% endif %}
    
    # Position restore logic is handled in pickup_gcode_stage2 for smoother motion
    # This section only configures Input Shaper
    
    ROUNDED_G0 D=0  # Flush motion buffer

# ------------------------------------------------------------------------------
# Error Handling
# ------------------------------------------------------------------------------

error_gcode:
    # Executed when a tool change error occurs
    # Safety: Turn off extruder, raise Z, store error context
    
    # Turn off extruder heater immediately (safety)
    M104 S0
    # NOTE: Bed heater stays ON to prevent print detachment
    
    # Raise Z to safe height (no XY movement in error state!)
    G90
    {% set min_safe_z = 20.0 %}
    {% set cur_z = printer.toolhead.position.z|float %}
    {% if cur_z < min_safe_z %}
        G0 Z{min_safe_z} F6000
    {% endif %}
    
    # Display error status
    {% if tool_number >= 0 %}
        M117 Toolchanger Error: T{tool_number}
    {% else %}
        M117 Toolchanger Error!
    {% endif %}
    
    # Set LED status to ERROR for visual feedback
    {% if "STATUS_ERROR" in printer.gcode %}
        STATUS_ERROR
    {% endif %}
    
    # Note: PAUSE is triggered automatically by toolchanger.py, not here

# ==============================================================================
# SECTION 3: TOOL CHANGE SEQUENCES
# ==============================================================================

# ------------------------------------------------------------------------------
# Pickup Stage 1: Approach and Partial Insertion
# ------------------------------------------------------------------------------
# First stage of two-stage pickup process
# Moves to dock, inserts tool partially, then stops at verification point

pickup_gcode_stage1:
    {% set x = tool.params_park_x|float %}
    {% set y = tool.params_park_y|float %}
    {% set z = tool.params_park_z|float %}
    {% set fast = tool.params_fast_speed|float %}
    {% set path = tool['params_' ~ tool.params_type ~ '_path'] %}

    G90  # Absolute positioning
    
    # Phase 1: Fast approach to dock area
    ROUNDED_G0 Y={tool.params_close_y} F={fast} D=5            # Move to close_y position
    ROUNDED_G0 X={x} Z={z + path[-1]['z']|float} F={fast} D=5  # Position X and Z
    ROUNDED_G0 Y={y + path[-1]['y']|float} F={fast} D=0        # Final Y approach
    
    # Phase 2: Wait for temperature stabilization
    {% if tool.extruder and printer[tool.extruder].target != 0 %}
      {% set target = printer[tool.extruder].target %}
      {% set tolerance = 5 %}
        TEMPERATURE_WAIT SENSOR={tool.extruder} MINIMUM={target - tolerance} MAXIMUM={target + tolerance}
    {% endif %}
    
    # Phase 3: Execute dock path in reverse until verification point
    # Find the verification point (marked with 'f' parameter)
    {% set verify_idx = namespace(value=-1) %}
    {% for i in range(path|length) %}
      {% if 'f' in path[i] %}
        {% set verify_idx.value = i %}
      {% endif %}
    {% endfor %}

    # Execute path from end to verification point (reverse order)
    {% for i in range(path|length - 1, verify_idx.value, -1) %}
      {% set pos = path[i] %}
      G0 Y{y + pos['y']|float} Z{z + pos['z']|float} F{tool.params_path_speed|float}
    {% endfor %}

    # Stop at verification point and wait for tool detection
    {% set verify_pos = path[verify_idx.value] %}
    G0 Y{y + verify_pos['y']|float} Z{z + verify_pos['z']|float} F{tool.params_path_speed|float * (verify_pos.get('f', 1.0)|float)}
    M400  # Wait for all moves to complete

# ------------------------------------------------------------------------------
# Pickup Stage 2: Complete Insertion and Return
# ------------------------------------------------------------------------------
# Second stage executed ONLY after successful tool verification
# Completes the pickup path and returns to safe position

pickup_gcode_stage2:
    {% set x = tool.params_park_x|float %}
    {% set y = tool.params_park_y|float %}
    {% set z = tool.params_park_z|float %}
    {% set fast = tool.params_fast_speed|float %}
    {% set path = tool['params_' ~ tool.params_type ~ '_path'] %}

    # Find verification point in path
    {% set verify_idx = namespace(value=-1) %}
    {% for i in range(path|length) %}
      {% if 'f' in path[i] %}
        {% set verify_idx.value = i %}
      {% endif %}
    {% endfor %}

    # Complete the dock path (verification point to start)
    {% for i in range(verify_idx.value - 1, -1, -1) %}
      {% set pos = path[i] %}
      G0 Y{y + pos['y']|float} Z{z + pos['z']|float} F{tool.params_path_speed|float}
    {% endfor %}

    # Return to safe Y position
    ROUNDED_G0 Y={tool.params_safe_y} F={fast} D=20
    
    # Restore previous position (provided by toolchanger module)
    {% if restore_position is defined %}
        {% if restore_position.Z is defined %}
            ROUNDED_G0 Z={restore_position.Z} F={tool.params_fast_speed} D=150
        {% endif %}
        {% if restore_position.X is defined %}
            ROUNDED_G0 X={restore_position.X} F={tool.params_fast_speed} D=1000
        {% endif %}
        {% if restore_position.Y is defined %}
            ROUNDED_G0 Y={restore_position.Y} F={tool.params_fast_speed} D=0
        {% endif %}
    {% endif %}
    ROUNDED_G0 D=0  # Flush motion buffer

# ------------------------------------------------------------------------------
# Dropoff: Return Tool to Dock
# ------------------------------------------------------------------------------
# Moves tool back to dock and releases it

dropoff_gcode:
    {% set x = tool.params_park_x|float %}
    {% set y = tool.params_park_y|float %}
    {% set z = tool.params_park_z|float %}
    {% set fast = tool.params_fast_speed|float %}
    {% set path = tool['params_' ~ tool.params_type ~ '_path'] %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
    {% set cur_z = printer.toolhead.position[2]|float %}

    G90  # Absolute positioning
    
    # Phase 1: Approach dock from safe position
    ROUNDED_G0 Y={tool.params_safe_y} D=20 F={fast}            # Move to safe Y
    ROUNDED_G0 X={x} D=150 F={fast}                            # Align X with dock
    ROUNDED_G0 Z={z + path[0]['z']|float} D=20 F={fast}       # Position Z above dock
    ROUNDED_G0 Y={y + path[0]['y']|float} D=0 F={fast}         # Final Y approach
    
    # Phase 2: Execute dock path forward (insertion to release)
    {% for pos in path %}
        G0 Y{y + pos['y']|float} Z{z + pos['z']|float} F{tool.params_path_speed|float * (pos.get('f', 1.0)|float)}
    {% endfor %}
    ROUNDED_G0 D=0  # Flush motion buffer

# ==============================================================================
# SECTION 4: ARCHIVED CODE (For Reference)
# ==============================================================================
# Previous implementations kept for debugging and reference

### CLAUDE.AI generated gcode (alternative single-stage pickup) ###
#pickup_gcode:
#    {% set x = tool.params_park_x|float %}
#    {% set y = tool.params_park_y|float %}
#    {% set z = tool.params_park_z|float %}
#    {% set fast = tool.params_fast_speed|float %}
#    {% set path = tool['params_' ~ tool.params_type ~ '_path'] %}
#    
#    RESPOND TYPE=echo MSG='Picking up {tool.name}'
#    G90
#    
#    ROUNDED_G0 Y={tool.params_close_y} F={fast} D=5
#    ROUNDED_G0 X={x} Z={z + path[-1]['z']|float} F={fast} D=5
#    ROUNDED_G0 Y={y + path[-1]['y']|float} F={fast} D=0
#    
#    {% if tool.extruder and printer[tool.extruder].target != 0 %}
#      {% set target = printer[tool.extruder].target %}
#      {% set tolerance = 5 %}
#      TEMPERATURE_WAIT SENSOR={tool.extruder} MINIMUM={target - tolerance} MAXIMUM={target + tolerance}
#    {% endif %}
#    
#    {% for pos in path|reverse %}
#      G0 Y{y + pos['y']|float} Z{z + pos['z']|float} F{tool.params_path_speed|float * (pos.get('f', 1.0)|float) }
#      {% if 'f' in pos %}
#        M400
#        VERIFY_TOOL_DETECTED T={tool.tool_number}
#      {% endif %}    
#    {% endfor %}
#    
#    # STOP HIER! Kein Move zu safe_y mehr!
#    # toolchanger.py macht restore_axis nach erfolgreicher Verifikation!

### original gcode ####
#pickup_gcode:
#    {% set x = tool.params_park_x|float %}
#    {% set y = tool.params_park_y|float %}
#    {% set z = tool.params_park_z|float %}
#    {% set fast = tool.params_fast_speed|float %}
#    {% set path = tool['params_' ~ tool.params_type ~ '_path'] %}
#    
#    RESPOND TYPE=echo MSG='Picking up {tool.name}'
#    G90
#    
#    ROUNDED_G0 Y={tool.params_close_y} F={fast} D=5
#    ROUNDED_G0 X={x} Z={z + path[-1]['z']|float} F={fast} D=5
#    ROUNDED_G0 Y={y + path[-1]['y']|float} F={fast} D=0
#    
#    {% if tool.extruder and printer[tool.extruder].target != 0 %}
#      {% set target = printer[tool.extruder].target %}
#      {% set tolerance = 5 %}
#      TEMPERATURE_WAIT SENSOR={tool.extruder} MINIMUM={target - tolerance} MAXIMUM={target + tolerance}
#    {% endif %}
#    
#    {% for pos in path|reverse %}
#      G0 Y{y + pos['y']|float} Z{z + pos['z']|float} F{tool.params_path_speed|float * (pos.get('f', 1.0)|float) }
#      {% if 'f' in pos %}
#        M400 ; Wait for moves to finish
#        VERIFY_TOOL_DETECTED T={tool.tool_number}
#        #INITIALIZE_TOOLCHANGER
#      {% endif %}    
#    {% endfor %}
# 
#    ROUNDED_G0 Y={tool.params_safe_y} F={fast} D=20
#    {% if 'Z' in restore_position %}
#      ROUNDED_G0 Z={restore_position.Z} F={fast} D=150
#    {% endif %}
#    {% if 'X' in restore_position %}
#      ROUNDED_G0 X={restore_position.X} F={fast} D=1000
#    {% endif %}
#    {% if 'Y' in restore_position %}
#      ROUNDED_G0 Y={restore_position.Y} F{fast} D=0
#    {% endif %}
#    ROUNDED_G0 D=0

# ==============================================================================
# SECTION 5: HELPER MACROS & OVERRIDES
# ==============================================================================

# ------------------------------------------------------------------------------
# Auto-Detection Initialization (Optional)
# ------------------------------------------------------------------------------

[gcode_macro _INITIALIZE_FROM_DETECTED_TOOL]
description: Auto-initialize toolchanger from detected tool (optional)
# Called from initialize_gcode if uncommented
# Waits for tool detection to settle, then initializes with detected tool
gcode:
    G4 P1500  # Wait 1.5s for detection to stabilize
    {% if printer.toolchanger.detected_tool is not none %}
        RESPOND TYPE=echo MSG="Tool {printer.toolchanger.detected_tool.name} detected, initializing"
        G92 E0  # Reset extruder position
        INITIALIZE_TOOLCHANGER TOOL={printer.toolchanger.detected_tool.name}
    {% else %}
        RESPOND TYPE=error MSG="No tool detected on startup"
        M117 No tool detected on startup
        #PAUSE  # Uncomment to pause if no tool detected
    {% endif %}

# ------------------------------------------------------------------------------
# Z-Stepper Current Management
# ------------------------------------------------------------------------------
# Temporarily boosts Z-stepper current during tool changes for extra holding force

[gcode_macro _TOOLCHANGER_TOOL_BEFORE_CHANGE]
description: Boost Z-stepper current before tool change
# Called automatically by toolchanger before each tool change
gcode:
    # Increase current to 2.0A for all Z steppers
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT=2.0
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=2.0
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=2.0
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=2.0

[gcode_macro _TOOLCHANGER_TOOL_AFTER_CHANGE]
description: Restore Z-stepper current after tool change
# Called automatically by toolchanger after each tool change completes
gcode:
    # Restore configured run_current values
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings['tmc5160 stepper_z'].run_current|float}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings['tmc5160 stepper_z1'].run_current|float}
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={printer.configfile.settings['tmc5160 stepper_z2'].run_current|float}
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={printer.configfile.settings['tmc5160 stepper_z3'].run_current|float}
    G4 P500  # Brief pause for current settling

# ------------------------------------------------------------------------------
# Temperature Command Overrides (M104/M109)
# ------------------------------------------------------------------------------
# Allows multi-tool temperature control using standard M-codes
# Usage: M104 T0 S220 (set T0 to 220°C) or M104 S220 (set current tool)

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
    {% if params.T is defined %}
        # Tool-specific temperature: redirect to SET_TOOL_TEMPERATURE
        {% set newparameters = " T="~params.T %}
        {% if params.S is defined %}
            {% set newparameters = newparameters ~ " TARGET="~params.S %}
        {% endif %}
        SET_TOOL_TEMPERATURE{newparameters}
    {% else %}
        # No tool specified: use original M104 for current tool
        M104.1 {rawparams}
    {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
    {% if params.T is defined %}
        # Tool-specific temperature with wait: redirect to SET_TOOL_TEMPERATURE
        {% set newparameters = " T="~params.T %}
        {% if params.S is defined %}
            {% set newparameters = newparameters ~ " TARGET="~params.S %}
        {% endif %}
        SET_TOOL_TEMPERATURE WAIT=0 {newparameters}
    {% else %}
        # No tool specified: use original M109 for current tool
        M109.1 {rawparams}
    {% endif %}
