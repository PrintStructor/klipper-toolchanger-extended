# ==============================================================================
# VORON TOOLCHANGER — TOOLHEAD T3 CONFIGURATION
# ==============================================================================
#
# ⚠️  WARNING: THIS CONFIG CONTAINS MY ACTUAL MACHINE VALUES!
# 
# YOU MUST CHANGE:
#   - CAN UUID: canbus_uuid ← YOUR UUID HERE
#   - Dock positions: params_park_x/y/z ← YOUR POSITIONS
#   - PID values: Run PID_CALIBRATE for YOUR hotend
#   - Input shaper: Run resonance tests for YOUR frame
#   - Offsets: Calibrate with NUDGE and BEACON for YOUR tools
#
# Find your CAN UUID:
#   ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
#
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Based on Viesturz's klipper-toolchanger configuration
# Original: https://github.com/viesturz/klipper-toolchanger
#
# Description:
#   Complete configuration for Toolhead 3 (T3) using BTT EBB36/42 CAN board.
#   Includes extruder, hotend, fans, sensors, and tool-specific parameters.
#
# Hardware:
#   - BTT EBB36/42 CAN board
#   - TMC2209 extruder driver with autotune
#   - ATC Semitec 104GT-2 thermistor
#   - Moons CSE14HRA1L410A extruder motor (50:8 geared)
#   - Filament runout sensor (switch-based)
#   - Optional ADXL345 accelerometer
#
# Features:
#   - CAN bus communication
#   - Per-tool input shaper configuration
#   - Dynamic tool offset management (XYZ)
#   - Filament sensor integration
#   - Temperature monitoring and verification
#   - Individual hotend fan control
#
# Structure:
#   1. CAN MCU Configuration
#   2. Temperature Monitoring
#   3. Extruder & Motor Driver
#   4. Heater Verification
#   5. Fans
#   6. Filament Sensors
#   7. Tool Macros & Parameters
#
# Initial Setup Required:
#   - Verify canbus_uuid matches your EBB board
#   - Calibrate extruder rotation_distance (extrusion test)
#   - Run PID tuning: PID_CALIBRATE HEATER=extruder3 TARGET=260
#   - Calibrate tool offsets (XY via NUDGE, Z via BEACON)
#   - Tune input shaper (optional ADXL345)
#
# Calibration Commands:
#   - PID_CALIBRATE HEATER=extruder3 TARGET=260
#   - DUMP_TMC STEPPER=extruder3
#   - QUERY_FILAMENT_SENSOR SENSOR=T3_filament_sensor
#
# ==============================================================================

# ==============================================================================
# SECTION 1: CAN MCU CONFIGURATION
# ==============================================================================

[mcu et3]
canbus_uuid: a89b40936579                  # T3 - Update with your board's UUID
# Reference UUIDs for other toolheads:
#canbus_uuid: fd90506bc323                 # T0
#canbus_uuid: 27a86b72746b                 # T1
#canbus_uuid: 8e7342a0122a                 # T2
#canbus_uuid: f7553e25a0a0                 # T4
#canbus_uuid: 5734e15d32b1                 # T5

# ------------------------------------------------------------------------------
# Optional: ADXL345 Accelerometer (for Input Shaper tuning)
# ------------------------------------------------------------------------------
# Uncomment to enable on-board accelerometer for resonance testing
#[adxl345]
#cs_pin: et3:PB12
#spi_software_sclk_pin: et3:PB10
#spi_software_mosi_pin: et3:PB11
#spi_software_miso_pin: et3:PB2
#axes_map: x, y, z

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    177.5, 177.5, 20                      # Center of bed at 20mm height

# ==============================================================================
# SECTION 2: TEMPERATURE MONITORING
# ==============================================================================

[temperature_sensor T3]
sensor_type: temperature_mcu               # MCU temperature sensor
sensor_mcu: et3
min_temp: 0
max_temp: 100                              # Max safe MCU temperature

# ==============================================================================
# SECTION 3: EXTRUDER & MOTOR DRIVER
# ==============================================================================

# ------------------------------------------------------------------------------
# Extruder Configuration
# ------------------------------------------------------------------------------

[extruder3]
# Stepper pins
step_pin: et3:PD0
dir_pin: !et3:PD1
enable_pin: !et3:PD2

# Heater configuration
heater_pin: et3:PB13
sensor_type: ATC Semitec 104GT-2
sensor_pin: et3:PA3

# Stepper configuration
microsteps: 16
full_steps_per_rotation: 200               # 200 for 1.8°, 400 for 0.9° stepper
gear_ratio: 50:8                           # Extruder gear reduction (e.g., Sherpa Mini)

# Physical parameters
nozzle_diameter: 0.400
filament_diameter: 1.750

# Extrusion calibration
# IMPORTANT: Calibrate with 100mm extrusion test
# Formula: new_value = old_value * (100 / actual_extruded)
rotation_distance: 23.238341495348

# Safety limits
min_extrude_temp: 170                      # Minimum temp for extrusion
min_temp: 10
max_temp: 300
max_power: 1.0
max_extrude_cross_section: 50              # Maximum cross-section for flow
max_extrude_only_distance: 700.00          # Max extrusion without XYZ move

# Temperature control (PID tuned)
# Run: PID_CALIBRATE HEATER=extruder3 TARGET=260
control: pid
pid_Kp: 38.059
pid_Ki: 10.149
pid_Kd: 35.680

# Pressure advance
pressure_advance: 0                        # Set in slicer per-filament
pressure_advance_smooth_time: 0.040        # Smoothing window (default 0.04s)

# ------------------------------------------------------------------------------
# TMC2209 Motor Driver with Autotune
# ------------------------------------------------------------------------------

[tmc2209 extruder3]
uart_pin: et3:PA15
interpolate: false                         # Disable 256 microstep interpolation
run_current: 0.60                          # Running current (A)
# Alternative currents for different scenarios:
#run_current: 0.65                         # LGX Lite spool ACT NEMA14
#run_current: 0.75                         # LGX Lite drybox ACT NEMA14
#run_current: 0.80                         # LGX Lite fast infill 300 mm/s
#run_current: 0.90                         # LGX Lite >32 mm³/s ACT NEMA14
hold_current: 0.30                         # Holding current (A)
sense_resistor: 0.110                      # Current sense resistor value
stealthchop_threshold: 0                   # Disable StealthChop (use SpreadCycle)

[autotune_tmc extruder3]
motor: moons-cse14hra1l410a                # Motor model for autotuning
tuning_goal: auto                          # Auto-select tuning parameters
voltage: 24                                # Supply voltage

# Debug: Use DUMP_TMC STEPPER=extruder3 to inspect TMC registers

# ==============================================================================
# SECTION 4: HEATER VERIFICATION & SAFETY
# ==============================================================================

[verify_heater extruder3]
max_error: 120                             # Max temperature deviation (°C)
check_gain_time: 120                       # Time window for error checking (s)
hysteresis: 50                             # Allowed temperature swing (°C)
heating_gain: 2                            # Minimum heating rate (°C/s)

# ==============================================================================
# SECTION 5: FANS
# ==============================================================================

# ------------------------------------------------------------------------------
# Hotend Fan (Temperature-Controlled)
# ------------------------------------------------------------------------------

[heater_fan T3_hotend_fan]
pin: et3:PA1
heater: extruder3
heater_temp: 50.0                          # Turn on above 50°C
max_power: 1.0
kick_start_time: 0.5                       # Boost time for startup

# ------------------------------------------------------------------------------
# Part Cooling Fan
# ------------------------------------------------------------------------------
# Configured globally in printer.cfg (shared CPAP blower system)

# ------------------------------------------------------------------------------
# RGB Lighting
# ------------------------------------------------------------------------------
# LED effects managed via tc_led_effects.cfg
# Requires klipper-led_effect plugin

# ==============================================================================
# SECTION 6: FILAMENT SENSORS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Detection Sensor (Optional)
# ------------------------------------------------------------------------------

#[filament_switch_sensor tool3_detection]
#switch_pin: ^et3:PB9
#pause_on_runout: False
#runout_gcode:
#    M117 T3 disconnected
#insert_gcode:
#    M117 T3 connected

# ------------------------------------------------------------------------------
# Filament Runout Sensor (Active)
# ------------------------------------------------------------------------------

[filament_switch_sensor T3_filament_sensor]
switch_pin: et3:PB8
pause_on_runout: False                     # Don't auto-pause on runout
# Query sensor: QUERY_FILAMENT_SENSOR SENSOR=T3_filament_sensor
#runout_gcode:
#    M117 T3 Runout Detected
#insert_gcode:
#    M117 T3 Filament Loaded
#event_delay: 3.0
#pause_delay: 0.5

# ------------------------------------------------------------------------------
# Filament Motion Sensor (Optional)
# ------------------------------------------------------------------------------

#[filament_motion_sensor T3_motion_sensor]
#switch_pin: ^et3:PB3
#detection_length: 7.0
#extruder: extruder3
#pause_on_runout: False

# ==============================================================================
# SECTION 7: TOOL MACROS & PARAMETERS
# ==============================================================================

# ------------------------------------------------------------------------------
# Tool Selection Macro
# ------------------------------------------------------------------------------

[gcode_macro T3]
description: Select Tool 3
variable_active: 0
gcode:
    SELECT_TOOL T=3
    _SET_ACTIVE_TOOL_FLAGS T=3

# ------------------------------------------------------------------------------
# Tool Parameters
# ------------------------------------------------------------------------------

[tool T3]
# Core configuration
tool_number: 3                             # Tool identifier (T3)
extruder: extruder3                        # Linked extruder
detection_pin: ^et3:PB9                    # Tool detection switch

# ------------------------------------------------------------------------------
# Tool Offsets (Managed Dynamically)
# ------------------------------------------------------------------------------
# These offsets are automatically managed by calibration macros:
# - XY offsets: Calibrated via NUDGE probe (calibrate_offsets.cfg)
# - Z offsets: Calibrated via BEACON contact (calibrate_offsets.cfg)
#
# DO NOT manually edit these unless recalibrating!
#gcode_x_offset: 0.00
#gcode_y_offset: 0.00
#gcode_z_offset: 0.00

# ------------------------------------------------------------------------------
# Relative Z-Offsets (T3 as Reference)
# ------------------------------------------------------------------------------
# Calibration values (commented during active use):
#t0_z_offset: 0.00000
#t1_z_offset: 0.00000
#t2_z_offset: 0.00000
#t4_z_offset: 0.00000
#t5_z_offset: 0.00000

# Active calibrated values:
#t0_z_offset:  0.00394
#t1_z_offset: -0.04700
#t2_z_offset: -0.10950
#t4_z_offset:  0.00238
#t5_z_offset:  0.04269

# ------------------------------------------------------------------------------
# Relative XY-Offsets (T3 as Reference)
# ------------------------------------------------------------------------------
# Calibration values (commented during active use):
#t0_xy_offset: 0.000000, 0.000000
#t1_xy_offset: 0.000000, 0.000000
#t2_xy_offset: 0.000000, 0.000000
#t4_xy_offset: 0.000000, 0.000000
#t5_xy_offset: 0.000000, 0.000000

# Active calibrated values:
#t0_xy_offset: -0.067000, -0.050000
#t1_xy_offset: -0.089000,  0.041000
#t2_xy_offset: -0.092000, -0.380000
#t4_xy_offset:  0.041000,  0.064000
#t5_xy_offset:  0.038000, -0.248000

# ------------------------------------------------------------------------------
# Tool Parking Position
# ------------------------------------------------------------------------------

params_park_x: 206.0                       # X dock position
params_park_y: 3.0                         # Y dock position
params_park_z: 325.0                       # Z dock position (safe height)

# ------------------------------------------------------------------------------
# Input Shaper Configuration (Per-Tool)
# ------------------------------------------------------------------------------

# X-axis shaper
params_input_shaper_type_x: 'ei'           # Shaper algorithm
params_input_shaper_freq_x: 79.2           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_x: 0.074 # Damping ratio

# Y-axis shaper
params_input_shaper_type_y: 'mzv'          # Shaper algorithm
params_input_shaper_freq_y: 42.8           # Resonance frequency (Hz)
params_input_shaper_damping_ratio_y: 0.049 # Damping ratio
