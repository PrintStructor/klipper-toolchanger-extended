# ==============================================================================
# VORON TOOLCHANGER — CORE PRINT MACROS
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 3.1
#
# Description:
#   Core macros for managing print workflows on the Voron Toolchanger.
#   Includes standardized print lifecycle management (start, end, pause, resume),
#   gantry leveling, homing procedures, and utility functions.
#
# Features:
#   - Intelligent print start sequence with bed heating & soaking
#   - Multi-stage Quad Gantry Leveling (coarse + fine)
#   - Adaptive bed meshing with Beacon contact probe
#   - Heat-safe pause/resume with toolchanger error handling
#   - Safe print cancellation with proper cleanup
#   - Emergency bed movement macros
#   - Aux fan control for Orca Slicer compatibility
#
# Structure:
#   1. Gantry Leveling & Homing
#   2. Print Lifecycle (Start/End/Pause/Resume/Cancel)
#   3. Utility Macros
#   4. Auxiliary Fans
#   5. Filament Management (Templates)
#
# Integration:
#   - Works with toolchanger_macros.cfg for tool management
#   - Uses KNOMI macros for display feedback
#   - Integrates with tc_led_effects.cfg for status LEDs
#   - Leverages beacon.cfg for probing & mesh
#
# Slicer Configuration:
#   Start G-Code: 
#     PRINT_START BED_TEMP=[bed_temperature] TOOL_TEMP=[nozzle_temperature] INITIAL_TOOL=0
#   End G-Code:
#     PRINT_END
#   Cancel G-Code:
#     CANCEL_PRINT
#
# ==============================================================================

# ==============================================================================
# SECTION 1: GANTRY LEVELING & HOMING
# ==============================================================================

# ------------------------------------------------------------------------------
# Quad Gantry Leveling (QGL) - Enhanced Multi-Stage Approach
# ------------------------------------------------------------------------------
# Why: Ensures precise gantry alignment before every print
# How: Two-stage process (coarse + fine) for optimal accuracy
# When: Automatically called during PRINT_START

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: BASE_QUAD_GANTRY_LEVEL
description: Enhanced QGL with coarse and fine calibration stages
gcode:
    # Wake up KNOMI displays to show QGL progress
    KNOMI_WAKE
    
    # Set KNOMI status to indicate QGL is running
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=True
    
    {% if printer.quad_gantry_level.applied == False %}
        # First-time QGL: Start with coarse adjustment from safe height
        # This prevents probe crashes on severely unlevel gantries
        BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=0.015
        
        # Follow up with fine calibration for precision
        FINE_QUAD_GANTRY_LEVEL
    {% else %}
        # Gantry was already leveled: Only fine calibration needed
        FINE_QUAD_GANTRY_LEVEL
    {% endif %}
    
    # Reset KNOMI status after QGL completion
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=False

[gcode_macro FINE_QUAD_GANTRY_LEVEL]
description: Fine-precision QGL pass at low Z height
gcode:
    # Perform precise QGL at Z=2mm for better accuracy
    # Lower height = better probe consistency
    BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=2.0

# ------------------------------------------------------------------------------
# Homing Check
# ------------------------------------------------------------------------------
# Why: Prevents redundant homing operations
# What: Only homes if axes are not already homed

[gcode_macro CHECK_HOMING]
description: Check if axes are homed, home if needed
gcode:
    {% if 'x' in printer.toolhead.homed_axes and 'y' in printer.toolhead.homed_axes and 'z' in printer.toolhead.homed_axes %}
        M117 Axes already homed, skipping G28
    {% else %}
        STATUS_HOMING
        M117 Homing all axes...
        G28                                    # Home all axes
        G0 Z5                                  # Lift to safe height
        G90                                    # Absolute positioning
    {% endif %}

# ------------------------------------------------------------------------------
# G32 - Legacy Gantry Calibration Macro
# ------------------------------------------------------------------------------
# Why: Provides compatibility with legacy G-Code
# What: Ensures T0 is active, clears mesh, performs QGL, re-homes Z

[gcode_macro G32]
description: Legacy macro for gantry calibration (QGL + Z home)
gcode:
    # Ensure T0 is active for consistent probing
    {% if printer.toolchanger.tool is none %}
        M117 Activating T0 for QGL...
        T0
    {% endif %}
    
    BED_MESH_CLEAR                             # Clear any existing mesh
    QUAD_GANTRY_LEVEL                          # Perform QGL
    G28 Z                                      # Re-home Z after QGL

# ------------------------------------------------------------------------------
# Print Status (Debug)
# ------------------------------------------------------------------------------
# Why: Debug helper for checking printer object states

[gcode_macro PRINT_STATUS]
description: Display status of a printer object (debug)
gcode: 
    RESPOND TYPE='echo' MSG="Status for {params.OBJ} is {printer[params.OBJ]}"

# ==============================================================================
# SECTION 2: PRINT LIFECYCLE MANAGEMENT
# ==============================================================================

# ------------------------------------------------------------------------------
# PRINT_START - Comprehensive Print Initialization
# ------------------------------------------------------------------------------
# Why: Prepares printer for optimal print quality
# What: Heats bed, performs QGL, meshes bed, heats tools
# Parameters:
#   - BED_TEMP: Target bed temperature (default: 110°C)
#   - TOOL_TEMP: Target tool temperature (default: 200°C)
#   - CHAMBER: Target chamber temperature (default: 40°C)
#   - INITIAL_TOOL: Tool to start with (default: 0)

[gcode_macro PRINT_START]
variable_printing: False
description: Comprehensive print start sequence with bed soak & calibration
gcode:
    # Wake up KNOMI displays
    KNOMI_WAKE
    
    # Parse parameters with defaults
    {% set target_bed = params.BED_TEMP|default(110)|int %}
    {% set target_extruder = params.TOOL_TEMP|default(200)|int %}
    {% set target_chamber = params.CHAMBER|default("40")|int %}
    {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
    {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
    {% set initial_tool = params.INITIAL_TOOL|default(0)|int %}

    # Initialize print state
    _ENABLE_FILAMENT_SENSORS
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    M117 Initializing...
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=False
    
    # Ensure homing and toolchanger initialization
    CHECK_HOMING
    INITIALIZE_TOOLCHANGER
    RESET_INITIAL_TOOL                         # Reset tool reference
    
    # Bed heating with optional soak period
    {% if target_bed > 80 %}
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}°C"
        STATUS_HEATING
        M106 S38                               # Enable part cooling at low speed
        G1 X{x_wait} Y{y_wait} Z2 F9000       # Move to center
        M190 S{target_bed}                     # Wait for bed temp
    {% else %}
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}°C"
        STATUS_HEATING
        G1 X{x_wait} Y{y_wait} Z2 F9000
        M190 S{target_bed}
        SET_DISPLAY_TEXT MSG="Soaking bed for 5min..."
    {% endif %}

    # Select initial tool and preheat to probing temperature
    T{initial_tool}
    M117 Pre-heating T{initial_tool} to 180°C (probing temp)
    M109 S180                                  # Wait for probing temp
    
    # Calibrate Z-offset with hot nozzle for thermal expansion
    G28 Z METHOD=CONTACT CALIBRATE=1
 
    # Perform Quad Gantry Leveling
    STATUS_LEVELING
    M117 Quad Gantry Leveling...
    QUAD_GANTRY_LEVEL

    # Generate adaptive bed mesh
    M117 Generating bed mesh...
    STATUS_MESHING
    BED_MESH_CALIBRATE ADAPTIVE=1

    # Recalibrate Z after gantry & mesh adjustments
    G28 Z METHOD=CONTACT CALIBRATE=0
    
    # Heat tool to final printing temperature
    SET_DISPLAY_TEXT MSG="Heating T{initial_tool}..."
    STATUS_HEATING
    M117 Heating T{initial_tool} to {target_extruder}°C
    T{initial_tool}
    M109 S{target_extruder}

    # Final print preparation
    G0 Z2 F300
    G92 E0                                     # Reset extruder position
    SKEW_PROFILE LOAD=CaliFlower              # Load skew correction
    SET_INITIAL_TOOL TOOL={initial_tool}       # Initialize tool offsets correctly
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=True
    
    STATUS_PRINTING
    PRIME_LINE                                 # Purge nozzle
    
    # Start continuous tool presence monitoring AFTER prime line
    UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=5.0
    
    M117 Printing...

# ------------------------------------------------------------------------------
# PRINT_END - Clean Print Completion
# ------------------------------------------------------------------------------
# Why: Safely ends print and prepares for next job
# What: Retracts filament, parks toolhead, cools down, resets offsets

[gcode_macro PRINT_END]
description: Clean print completion with safe toolhead parking
gcode:
    # Stop continuous tool presence monitoring
    UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=0
    
    STATUS_PART_READY
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=False
    SET_SKEW CLEAR=1                           # Clear skew correction
    M400                                       # Wait for buffer to clear
    G92 E0                                     # Zero extruder
    G1 E-4.0 F3600                            # Retract filament
    G91                                        # Relative positioning
    
    # Get machine boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Calculate safe movement directions
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    # Move to break stringing
    G0 X{x_safe} Y{y_safe} F20000             # XY wipe
    G0 Z{z_safe} F3600                         # Z lift
    
    # Shutdown heaters and fans
    TURN_OFF_HEATERS
    M107                                       # Part cooling fan off
    M140                                       # Bed heater off

    # Park toolhead
    G90                                        # Absolute positioning
    {% set tool = printer[printer.toolchanger.tool] %}
    G0 X{tool.params_park_x} Y{tool.params_safe_y} F3600
    
    M18                                        # Disable motors
    M117 Print finished!
    
    # Cleanup
    _DISABLE_FILAMENT_SENSORS
    BED_MESH_CLEAR
    RESET_INITIAL_TOOL                         # Reset tool reference
    SET_GCODE_OFFSET X=0 Y=0 Z=0 ABSOLUTE=1   # Clear all offsets

# ------------------------------------------------------------------------------
# PRIME_LINE - Nozzle Purge
# ------------------------------------------------------------------------------
# Why: Ensures consistent first layer by purging any inconsistent filament
# What: Draws two parallel lines at front of bed

[gcode_macro PRIME_LINE]
description: Purge nozzle by drawing prime lines at bed front
gcode: 
    M117 Purging nozzle...
    # Move to start position
    G1 X10 Y5 Z0.36 F5000.0
    # Draw first line
    G1 X80.0 Y5 Z0.36 F1500.0 E30
    # Move slightly over
    G1 X80.0 Y5.2 Z0.36 F5000.0
    # Draw second line (back)
    G1 X10 Y5.2 Z0.36 F1500.0 E30
    # Reset extruder
    G92 E0
    # Lift nozzle
    G1 Z2.0 F3000

# ------------------------------------------------------------------------------
# PAUSE - Heat-Safe & Toolchanger-Aware
# ------------------------------------------------------------------------------
# Why: Safely pauses print while preventing cold extrusion
# What: Parks toolhead, retracts if hot, handles toolchanger errors
# Parameters:
#   - E: Retraction distance (default: 2mm)

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_last_extruder_temp: {'restore': False, 'temp': 0}
description: Heat-safe pause with toolchanger error handling
gcode:
    {% set e = params.E|default(2)|float %}

    {% set th = printer.toolhead %}
    {% set tc = printer.toolchanger if "toolchanger" in printer else {} %}
    {% set in_tc_error = (tc.status|default("") == "error") %}
    {% set already_paused = printer.pause_resume.is_paused %}

    # Get extruder info for temperature check
    {% set ex_name = th.extruder if th.extruder in printer else "extruder" %}
    {% set ex = printer[ex_name] if ex_name in printer else None %}
    {% set Tmin = (ex.min_extrude_temp|default(170)|float) if ex else 170.0 %}
    {% set Tnow = (ex.temperature|float) if ex else 0.0 %}
    {% set can_retract = (Tnow >= Tmin and e > 0.0) %}

    # Save current temperature for resume
    {% set temp = printer[th.extruder].target if th.extruder != '' else 0 %}
    {% set restore = True if temp > 0 else False %}
    SET_GCODE_VARIABLE MACRO=PAUSE VARIABLE=last_extruder_temp VALUE="{{'restore': restore, 'temp': temp}}"

    # Get tool parking position
    {% set tool_name = tc.tool|default(None) %}
    {% set tool = printer[tool_name] if tool_name and (tool_name in printer) else None %}

    # Get machine boundaries
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}

    # Calculate safe moves
    {% set x_safe = 20.0 if th.position.x < (max_x - 20.0) else -20.0 %}
    {% set y_safe = 20.0 if th.position.y < (max_y - 20.0) else -20.0 %}
    {% set z_safe = 20.0 if th.position.z < (max_z - 20.0) else (max_z - th.position.z) %}

    {% set park_x = tool.params_park_x|float if tool else 175.0 %}
    {% set park_y = tool.params_safe_y|float if tool else 175.0 %}

    # Save state
    SAVE_GCODE_STATE NAME=PAUSE_state
    M400
    SET_IDLE_TIMEOUT TIMEOUT=3600              # Extend timeout during pause

    # Pause the print BEFORE moving (critical for position save!)
    PAUSE_BASE

    # Handle toolchanger error state
    {% if "toolchanger" in printer %}
        {% if tc.status|lower == "error" %}
            G4 P10
            {% if "STATUS_ERROR" in printer.gcode %}
                STATUS_ERROR
            {% endif %}
            M106 S0
            {% if can_retract %}
                G91
                G1 E-{e} F2100
                G90
            {% endif %}
        {% endif %}
    {% endif %}

    # Normal pause behavior - move to park position
    {% if (not in_tc_error) and (not already_paused) and ('xyz' in th.homed_axes) %}
        G91
        G1 Z{z_safe} F3600                     # Lift Z
        G1 X{x_safe} Y{y_safe} F20000         # Move away
        G90
        G1 X{park_x} Y{park_y} F3600          # Park at tool position
    {% endif %}

    # Retract if hot
    {% if can_retract %}
        G91
        G1 E-{e} F2100
        G90
    {% endif %}

    M106 S0                                    # Turn off part cooling

    # Update LED status
    {% if printer.toolchanger.tool_number is defined and "STATUS_PAUSE" in printer.gcode %}
        STATUS_PAUSE TOOL={printer.toolchanger.tool_number}
    {% elif "STATUS_PAUSE" in printer.gcode %}
        STATUS_PAUSE
    {% endif %}

# ------------------------------------------------------------------------------
# RESUME - Heat-Safe with Conditional Priming
# ------------------------------------------------------------------------------
# Why: Safely resumes print, only priming if extruder is hot
# What: Restores state, primes nozzle if temperature allows
# Parameters:
#   - E: Prime length (default: 2mm)

[gcode_macro RESUME]
rename_existing: RESUME_BASE
variable_saved_target: 0
description: Heat-safe resume with position restore and auto-reheat
gcode:
    # Check if resuming from toolchanger error
    {% set from_tc_error = (printer.toolchanger.status == "error") %}
    
    {% if from_tc_error %}
        # ==================================================================
        # TOOLCHANGER ERROR RECOVERY MODE
        # ==================================================================
        M117 Recovering from toolchanger error...
        
        # Reset toolchanger status first
        RESET_TOOLCHANGER_STATUS
        
        # Get extruder info for heating
        {% set th = printer.toolhead %}
        {% set ex_name = th.extruder if th.extruder in printer else "extruder" %}
        {% set ex = printer[ex_name] if ex_name in printer else None %}
        {% set Tmin = (ex.min_extrude_temp|default(170)|float) if ex else 170.0 %}
        {% set Tnow = (ex.temperature|float) if ex else 0.0 %}
        {% set Ttarget = (ex.target|float) if ex else 0.0 %}
        {% set can_extrude = (ex and ex.can_extrude) if ex else False %}
        
        # Heat if needed
        {% if Ttarget > 0 and Tnow < Ttarget - 5 %}
            M117 Heating tool to {Ttarget}°C...
            M109 S{Ttarget}
        {% endif %}
        
        # Extrude/prime if hot enough
        {% if can_extrude %}
            _CLIENT_EXTRUDE
        {% endif %}
        
        # Restore LED status
        {% if "STATUS_PRINTING" in printer.gcode and printer.toolchanger.tool_number is defined %}
            STATUS_PRINTING TOOL={printer.toolchanger.tool_number}
        {% elif "STATUS_PRINTING" in printer.gcode %}
            STATUS_PRINTING
        {% endif %}
        
        M117 Error recovery complete - ready to print
        
    {% else %}
        # ==================================================================
        # NORMAL RESUME MODE
        # ==================================================================
        {% set velocity = printer.configfile.settings.pause_resume.recover_velocity %}
        {% set sp_move = velocity %}
        
        {% set th = printer.toolhead %}
        {% set ex_name = th.extruder if th.extruder in printer else "extruder" %}
        {% set ex = printer[ex_name] if ex_name in printer else None %}
        {% set Tmin = (ex.min_extrude_temp|default(170)|float) if ex else 170.0 %}
        {% set Tnow = (ex.temperature|float) if ex else 0.0 %}
        {% set Ttarget = (ex.target|float) if ex else 0.0 %}
        {% set saved = printer["gcode_macro RESUME"].saved_target|float %}
        {% set can_extrude = (ex and ex.can_extrude) if ex else False %}
        
        # Get temperature from PAUSE macro as fallback
        {% set pause_temp = printer["gcode_macro PAUSE"].last_extruder_temp %}
        {% set pause_saved = pause_temp.temp|float if pause_temp.restore else 0.0 %}

        # Restore LED status to printing
        {% if "STATUS_PRINTING" in printer.gcode and printer.toolchanger.tool_number is defined %}
            STATUS_PRINTING TOOL={printer.toolchanger.tool_number}
        {% elif "STATUS_PRINTING" in printer.gcode %}
            STATUS_PRINTING
        {% endif %}

        # STEP 1: Determine target temperature from multiple sources
        # Priority: Ttarget > saved_target > pause_saved
        {% set target_temp = Ttarget if Ttarget > 0 else (saved if saved > 0 else pause_saved) %}
        
        {% if target_temp > 0 and Tnow < target_temp - 5 %}
            M117 Heating tool to {target_temp}°C...
            M109 S{target_temp}  # Wait for target temperature
        {% endif %}
        
        # STEP 2: Prime/Unretract using Mainsail's method (if hot enough)
        {% if can_extrude %}
            _CLIENT_EXTRUDE
        {% endif %}
        
        # STEP 3: Resume print with diagonal movement (RESUME_BASE handles position restore)
        RESUME_BASE VELOCITY={params.VELOCITY|default(sp_move)}
    {% endif %}

# ------------------------------------------------------------------------------
# CANCEL_PRINT - Safe Print Cancellation
# ------------------------------------------------------------------------------
# Why: Cleanly aborts print and resets all systems
# What: Parks toolhead, turns off heaters, clears all offsets

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
description: Safe print cancellation with full system reset
gcode:
    {% set tool = printer[printer.toolchanger.tool] %}
    
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=False
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT
    
    # Get machine boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Calculate safe moves
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    BED_MESH_CLEAR
    
    # Perform safe moves
    G91
    G1 Z{z_safe} F3600                         # Lift Z first
    G1 X{x_safe} Y{y_safe} F20000              # Move away
    G90
    G0 X{tool.params_park_x} Y{tool.params_safe_y} F3600  # Park
    
    M84                                        # Disable motors
    M106 S0                                    # Part cooling off
    
    # Reset everything
    _DISABLE_FILAMENT_SENSORS
    SET_SKEW CLEAR=1
    RESET_INITIAL_TOOL
    SET_GCODE_OFFSET X=0 Y=0 Z=0 ABSOLUTE=1
    
    M117 Print canceled

# ==============================================================================
# SECTION 3: UTILITY MACROS
# ==============================================================================

[gcode_macro DISABLE_MOTORS]
description: Disable all stepper motors
gcode:
    M18

# ------------------------------------------------------------------------------
# Debug Tool Detection
# ------------------------------------------------------------------------------

[gcode_macro DEBUG_TOOL_DETECTION]
description: Display current tool detection status for debugging
gcode:
    RESPOND MSG="=== TOOL DETECTION DEBUG ==="
    RESPOND MSG="Print State: {printer.print_stats.state}"
    RESPOND MSG="TC Status: {printer.toolchanger.status}"
    RESPOND MSG="TC Has Detection: {printer.toolchanger.has_detection}"
    RESPOND MSG="Current Tool: {printer.toolchanger.tool.name if printer.toolchanger.tool else 'None'}"
    RESPOND MSG="Detected Tool: {printer.toolchanger.detected_tool.name if printer.toolchanger.detected_tool else 'None'}"
    {% for tool_num in printer.toolchanger.tool_numbers %}
        {% set tool = printer['tool T' + tool_num|string] %}
        RESPOND MSG="T{tool_num} detect_state: {tool.detect_state}"
    {% endfor %}

# ------------------------------------------------------------------------------
# Emergency Bed Movement (Use with Extreme Caution!)
# ------------------------------------------------------------------------------
# ⚠️ WARNING: These macros bypass homing and safety checks
# Only use when absolutely necessary (e.g., removing stuck prints)

[gcode_macro UNSAFE_LOWER_BED_100]
description: ⚠️ UNSAFE: Lower bed 100mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=100
    G0 Z0 F600
    M84

[gcode_macro UNSAFE_LOWER_BED_10]
description: ⚠️ UNSAFE: Lower bed 10mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=10
    G0 Z0 F600
    M84

[gcode_macro UNSAFE_RAISE_BED_100]
description: ⚠️ UNSAFE: Raise bed 100mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=0
    G0 Z100 F600
    M84

[gcode_macro UNSAFE_RAISE_BED_10]
description: ⚠️ UNSAFE: Raise bed 10mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=0
    G0 Z10 F600
    M84

# ==============================================================================
# SECTION 4: AUXILIARY FANS (Orca Slicer Compatibility)
# ==============================================================================
# Why: Orca Slicer uses M106 with P parameter for aux fans
# What: Bridges M106 to Klipper's SET_FAN_SPEED

[gcode_macro M106]
description: Set fan speed with Orca Slicer P parameter support
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    SET_FAN_SPEED FAN={fan} SPEED={speed}

# ==============================================================================
# SECTION 5: FILAMENT MANAGEMENT (Templates - Disabled)
# ==============================================================================
# The following macros are provided as templates for filament change workflows.
# Uncomment and customize as needed for your setup.

#[gcode_macro M600]
#description: Filament change - pauses, parks, retracts 50mm
#gcode:
#    {% set X = params.X|default(5)|float %}
#    {% set Y = params.Y|default(310)|float %}
#    {% set Z = params.Z|default(10)|float %}
#    SAVE_GCODE_STATE NAME=M600_state
#    PAUSE
#    G91
#    G1 E-.8 F2700
#    G1 Z{Z}
#    G90
#    G1 X{X} Y{Y} F3000
#    G91
#    G1 E-50 F1000
#    RESTORE_GCODE_STATE NAME=M600_state

#[gcode_macro LOAD_FILAMENT]
#description: Load filament with heating and extrusion
#variable_ignore_min_extrude_temp: True
#gcode:
#    M117 Loading filament...
#    M104 S240
#    G90
#    G1 X100 Y20 Z20 F1800
#    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
#    M83
#    G1 E50 F300
#    G1 E50 F300
#    G1 E-4 F1800
#    M82
#    M400
#    M104 S0
#    M117 Loading done

#[gcode_macro UNLOAD_FILAMENT]
#description: Unload filament with heating and retraction
#variable_ignore_min_extrude_temp: True
#gcode:
#    M117 Unloading filament...
#    M104 S240
#    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
#    M83
#    G1 E5 F500
#    G1 E-50 F1000
#    G1 E-50 F1000
#    M82
#    M400
#    TURN_OFF_HEATERS
#    M117 Unloading done

#[gcode_macro UNLOAD_ONE_FILAMENT]
#description: Unload filament from specific tool
#gcode:
#    M117 Unloading {params.TOOL}
#    M109 T{params.TOOL} S240
#    {% set tool_name = printer.toolchanger.tool_names[params.TOOL|int] %}
#    {% set extruder = printer[tool_name].extruder %}
#    TEMPERATURE_WAIT SENSOR={extruder} MINIMUM=240
#    ACTIVATE_EXTRUDER EXTRUDER={extruder}
#    M83
#    G1 E5 F500
#    G1 E-50 F1000
#    G1 E-50 F1000
#    M82
#    M400
#    TURN_OFF_HEATERS
#    M117 Unloading done

#[gcode_macro UNLOAD_ALL_FILAMENT]
#description: Unload filament from all tools sequentially
#gcode:
#    {% set tools = printer.toolchanger.tool_names %}
#    M117 Unloading all tools...
#    {% for tool in tools %}
#        M104 T{printer[tool].tool_number} S240
#    {% endfor %}
#    {% for tool in tools %}
#        M109 T{printer[tool].tool_number} S240
#        ACTIVATE_EXTRUDER EXTRUDER={printer[tool].extruder}
#        M83
#        G1 E5 F500
#        G1 E-50 F1000
#        G1 E-50 F1000
#    {% endfor %}
#    M400
#    M82
#    TURN_OFF_HEATERS
#    M117 Unloading done
