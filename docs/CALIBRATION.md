# Calibration Guide

This document explains how to calibrate a multi‑tool printer using
`klipper-toolchanger-extended`, focusing on:

- XY alignment between tools
- Z offsets for all tools
- When and how to re‑calibrate

The examples assume:

- Reference tool = **T0**
- Probe = **Beacon** (concept also works with other probes)

---

## 1. Calibration Philosophy

The fork assumes:

- One **reference tool** (usually T0)
- All other tools are defined **relative** to that reference:
  - XY offsets (nozzle alignment over the bed)
  - Z offsets (nozzle tip height)

This has several advantages:

- Changing one tool does **not** force recalibration of every other tool
- Recovery macros can trust the relative alignment
- It is easy to add or replace a single tool

---

## 2. Prerequisites

Before running any of the calibration helpers, make sure:

- Your printer can home all axes reliably (`G28`)
- Your Z‑probe is working and has been validated on **at least one** tool
- Basic pickup and dropoff work for all tools, without collisions
- The docks are roughly where they should be (no massive misalignment)

**Safety tips:**

- Keep your hand near the emergency stop during first runs
- Start with conservative movement speeds
- Never leave the printer unattended during calibration

---

## 3. Choosing a Reference Tool

Pick one tool as the **reference** – all others will be aligned to it.

Typical choice:

- T0 = your “main” nozzle (e.g. 0.4 mm generic tool)
- Mechanically stable
- Easily accessible

Declare it in Klipper before running calibration helpers:

```gcode
SET_INITIAL_TOOL TOOL=0
```

You can change the reference later, but that will require recalibration.

---

## 4. XY Calibration – `NUDGE_FIND_TOOL_OFFSETS`

### 4.1. What It Does

`NUDGE_FIND_TOOL_OFFSETS` helps you:

- Align each tool’s XY position to match the reference tool
- Compute `[tool N]` XY offsets automatically
- Store those offsets via `SAVE_CONFIG`

It uses a **“nudge until it lines up”** workflow:

1. Move reference tool over a target spot
2. Switch to another tool
3. Nudge it until it matches the same spot
4. Record the delta as that tool’s XY offset

This is much faster and more intuitive than manually measuring & editing
numbers in the config.

---

### 4.2. Preparation

1. Home all axes:

   ```gcode
   G28
   ```

2. Heatbed should be at a normal print temperature (optional, but recommended
   for realistic geometry).

3. Make sure your docks & tools are:
   - Mounted firmly
   - Not loose or flexing
   - Capable of reliable pickup / dropoff

4. Choose a **reference mark** on the bed:
   - A small printed dot
   - A crosshair drawn with a marker
   - A point at a known coordinate (e.g. near bed center)

---

### 4.3. Running the Macro

With the reference tool selected:

```gcode
SET_INITIAL_TOOL TOOL=0
NUDGE_FIND_TOOL_OFFSETS INITIAL_TOOL=0
```

The macro will:

- Move the reference tool to the target area
- Switch between tools as needed
- Allow you to manually nudge each non‑reference tool into alignment

The exact user interaction (console prompts / UI messages) depends on the
current version, but the basic idea is always:

1. Place **T0** exactly over the reference mark.
2. Switch to another tool (T1, T2, …).
3. Use your UI jog controls to move that tool so the nozzle is exactly
   over the same mark.
4. Confirm when aligned (follow the on‑screen instructions).
5. Macro computes the XY offset between that tool and T0.
6. Repeat for all tools.

---

### 4.4. Saving the Results

When you are satisfied with the alignment:

```gcode
SAVE_CONFIG
```

Klipper will write the computed XY offsets into your config file, typically
in a section similar to:

```ini
# Generated by NUDGE_FIND_TOOL_OFFSETS
# tool offsets relative to T0
#t1_xy_offset: ...
#t2_xy_offset: ...
...
```

(Exact names may differ depending on your version and configuration.)

Restart Klipper if prompted.

---

### 4.5. Verifying XY Alignment

After saving:

1. Home again: `G28`
2. Set initial tool: `SET_INITIAL_TOOL TOOL=0`
3. Move T0 to the reference mark
4. Switch to another tool (T1…T5)
5. Each tool should now:
   - Be directly over the same mark
   - Only require very small corrections, if any

If a particular tool is still off noticeably:

- Re‑run `NUDGE_FIND_TOOL_OFFSETS` for that tool
- Or manually tweak its offset section in the config

---

## 5. Z Calibration – `MEASURE_TOOL_Z_OFFSETS`

### 5.1. What It Does

`MEASURE_TOOL_Z_OFFSETS`:

- Uses your Z‑probe (Beacon or other) to measure how “tall” each tool is
- Computes each tool’s Z offset relative to the reference tool
- Stores those offsets via `SAVE_CONFIG`

This makes sure that:

- When you switch tools, the **first layer height stays consistent**
- Multi‑tool prints do **not** leave grooves or layer ridges at the tool boundaries

---

### 5.2. Preparation

1. Make sure your reference tool (T0) has a **correct** Z offset already,
   using your normal procedure (e.g. `PROBE_CALIBRATE` + `SAVE_CONFIG`).

2. Heat to normal print temperatures:
   - Bed: your usual temperature for the material
   - Tools: typical nozzle temperature

3. Home all axes:

   ```gcode
   G28
   ```

4. Set the initial (reference) tool:

   ```gcode
   SET_INITIAL_TOOL TOOL=0
   ```

---

### 5.3. Running the Macro

With everything homed, heated, and reference set:

```gcode
MEASURE_TOOL_Z_OFFSETS INITIAL_TOOL=0
```

The macro will typically:

1. Use the reference tool to establish a baseline vs. the probe
2. Switch to each tool (T1…)
3. Probe at defined points
4. Compute how much higher or lower each tool is relative to T0
5. Build a table of Z offsets

Depending on your setup, this may take several minutes (especially
with many tools).

---

### 5.4. Saving the Results

When the macro finishes, review the console output for:

- Any errors / probe failures
- Reasonable‑looking offsets (usually within a few tenths of a millimeter)

If everything looks good:

```gcode
SAVE_CONFIG
```

Klipper will append or update the Z offset values for each tool, e.g.:

```ini
# tool z offsets relative to T0
#t1_z_offset: ...
#t2_z_offset: ...
...
```

Restart Klipper if needed.

---

### 5.5. Verifying Z Alignment

The simplest verification is a **multi‑tool first layer test**:

1. Slice a small test that uses several tools:
   - Adjacent squares or stripes
   - Each region printed by a different tool

2. Print it and observe:

   - Do all areas have a similar first‑layer squish?
   - Are there visible steps where the tool changes?
   - Do some regions look too squished or too high?

3. If a tool is clearly off:
   - Note the tool number
   - Either:
     - Re‑run `MEASURE_TOOL_Z_OFFSETS` for that tool, **or**
     - Manually adjust its Z offset by a small amount and `SAVE_CONFIG`

---

## 6. When to Re‑Calibrate

Re‑run **XY calibration** (`NUDGE_FIND_TOOL_OFFSETS`) when:

- You move or re‑print a dock
- You change a toolhead mechanically (hotend, carriage, etc.)
- You notice misalignment between colors / tools in finished prints

Re‑run **Z calibration** (`MEASURE_TOOL_Z_OFFSETS`) when:

- You change a nozzle length (e.g. different brand / style)
- You alter the hotend stack on a tool
- You see consistent first‑layer differences between tools

As a rule of thumb:

- **Minor firmware / slicer changes:** no recalibration needed
- **Mechanical changes to a tool or dock:** re‑calibrate that tool
- **Changes to probe mount / bed hardware:** re‑calibrate Z for all tools

---

## 7. Troubleshooting Calibration Issues

### 7.1. Tool Crashes During Calibration

- Stop immediately (emergency stop)
- Check:
  - Dock positions in `T*.cfg`
  - Homing and axis limits
  - That reference tool is correctly set (`SET_INITIAL_TOOL`)

Before retrying, manually test pickup/dropoff at **reduced speeds**.

---

### 7.2. Offsets Are Huge or Nonsense

If the computed offsets are clearly wrong (e.g. many millimeters off):

- Do **not** trust them
- Restore from backup or remove the bad offsets from `printer.cfg`
- Reboot Klipper
- Investigate:
  - Wrong reference tool used?
  - Probe misconfigured?
  - Mechanical looseness (e.g. loose tool, bent dock)?

Then repeat the relevant calibration step more carefully.

---

### 7.3. First Layer Still Inconsistent

If Z offsets look okay but first layer quality still differs:

- Check:
  - Bed mesh is active and consistent
  - Per‑tool temperature differences (different materials)
  - Tool cooling (extreme fan differences can curve parts)
- Consider:
  - Using a calibration print that exercises *only Z* first, without tool changes

---

## 8. Summary

1. **Pick a reference tool** (usually T0) and set it:

   ```gcode
   SET_INITIAL_TOOL TOOL=0
   ```

2. **Calibrate XY** for all tools:

   ```gcode
   NUDGE_FIND_TOOL_OFFSETS INITIAL_TOOL=0
   SAVE_CONFIG
   ```

3. **Calibrate Z** for all tools:

   ```gcode
   MEASURE_TOOL_Z_OFFSETS INITIAL_TOOL=0
   SAVE_CONFIG
   ```

4. **Verify**:
   - Tools line up over a common mark
   - First layers are consistent for all tools

Once these steps are done, your tool offsets should be solid enough
to run real multi‑tool prints with confidence.

For deeper background and real‑world examples, see:

- `WHY_THIS_FORK.md`
- `SUCCESS_STORIES.md`
